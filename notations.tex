% Proof trees macros

\NewDocumentCommand{\rnm}{mO{}tr}
  {{\small$
    \IfBooleanT{#3}{\overline}{
      #1
    }^{#2}$}}

\NewDocumentCommand{\R}{oO{}trtd}{
  \expandafter\prftree\expanded{
    \IfBooleanT{#4}{[d]}
    \IfValueT{#1}{[r]{
      \unexpanded{\rnm{#1}}
      [#2]
      \IfBooleanT{#3}{r}
    }}
  }
}

\NewDocumentCommand{\Rsf}{oO{}trtd}{
  \expandafter\prftree\expanded{
    \IfBooleanT{#4}{[d]}
    \IfValueT{#1}{[r]{
      \unexpanded{\rnmsf{#1}}
      [#2]
      \IfBooleanT{#3}{r}
    }}
  }
}

\newcommand{\rnmsf}[1]{\rnm{\mathsf{#1}}}
\newcommand{\rsf}[1]{\text{\small$\mathsf{#1}$}}

\newcommand{\assum}{\prfassumption}
\newcommand{\summ}{\prfsummary}

% -------------------------------
% ---------- Notations ----------
% -------------------------------

% Long digression in the margin
\NewEnviron{digression}{
  \marginnote{
    \begin{kaodigression}
      \BODY
    \end{kaodigression}
  }
}

% Thick table lines
\makeatletter
\newcommand{\thickhline}{%
    \noalign {\ifnum 0=`}\fi \hrule height 1pt
    \futurelet \reserved@a \@xhline
}
\newcolumntype{"}{@{\hskip\tabcolsep\vrule width 1pt\hskip\tabcolsep}}
\makeatother

% \xleftrightarrow without mathtools
\makeatletter
\newcommand\xleftrightarrow[2][]{%
  \ext@arrow 9999{\longleftrightarrowfill@}{#1}{#2}}
\newcommand\longleftrightarrowfill@{%
  \arrowfill@\leftarrow\relbar\rightarrow}
\makeatother

% Small line break
\newcommand{\sbr}{~\\\vspace{-1em}}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\newcommand{\mt}{\qquad\mapsto\qquad}

\newcommand{\HOne}{\color{hypnum}\ding{172}}
\newcommand{\HTwo}{\color{hypnum}\ding{173}}
\newcommand{\HThree}{\color{hypnum}\ding{174}}
\newcommand{\HFour}{\color{hypnum}\ding{175}}
\newcommand{\HFive}{\color{hypnum}\ding{176}}

\newcommand{\Hyp}[1]{\colorbox{hyp}{#1}}

\newcommand{\bcase}{\textbf{Base case}}
\newcommand{\rcase}{\textbf{Recursive case}}

\newcommand{\Ceq}{\mathrel{\vcenter{\hbox{::}}{=}}}

\newcommand{\syneq}{\equiv}

\newcommand{\nats}{\mathbb{N}}

% Vertical and horizontal reflection in math mode
\newcommand{\hrefl}[1]{\text{\raisebox{\depth}{\scalebox{-1}[1]{$#1$}}}}
\newcommand{\vrefl}[1]{\text{\raisebox{\depth}{\scalebox{-1}[-1]{$#1$}}}}
\newcommand{\hvrefl}[1]{\text{\raisebox{\depth}{\scalebox{1}[-1]{$#1$}}}}

\newcommand{\sep}{\;\!;\!\;}

\newcommand{\defeq}{\triangleq}

\newcommand{\da}{\downarrow}
\newcommand{\ua}{\uparrow}

\newcommand{\seq}{\Rightarrow}
\newcommand{\limp}{\supset}
\newcommand{\lsub}{\subset}
\newcommand{\lequiv}{\Leftrightarrow}

\newcommand{\mcirc}{\mathbin{⚬}}
\newcommand{\mdiam}{◇}

\DeclareRobustCommand{\sys}[1]{$\mathsf{#1}$}

\newcommand{\hole}{\square}
\newcommand{\cfill}[2]{#1\select{#2}}

\newcommand{\lstep}{\rightharpoonup}
\newcommand{\step}{\rightarrow}
\newcommand{\steps}{\step^\ast}
\newcommand{\nsteps}[1]{\step^{#1}}

\newcommand{\lstepsys}[1]{\lstep_{#1}}
\newcommand{\stepsys}[1]{\step_{#1}}
\newcommand{\stepssys}[1]{\steps_{#1}}

\newcommand{\notstep}{\nrightarrow}
\newcommand{\notsteps}{\nrightarrow^\ast}

\newcommand{\xlstep}[1]{\xrightharpoonup{#1}}
\newcommand{\xstep}[1]{\xrightarrow{#1}}
\newcommand{\xinvstep}[1]{\xleftrightarrow{#1}}
\newcommand{\xsteps}[1]{\xrightarrow{#1}\!\!\raisebox{3pt}[3pt]{\small$\ast$}~}

\newcommand{\deriv}[3]{#1 : #2 \steps #3}
\newcommand{\irule}[3]{#1 : #2 \rightarrow #3}
\newcommand{\rrule}[3]{#2 \rightarrow_{#1} #3}

\newcommand{\fentails}{\sdtstile{}{}}
\newcommand{\fequiv}{\sdststile{}{}}
\newcommand{\nturn}[1]{\lefteqn{\lapbox{1.88ex}{\raisebox{.38ex}{\scriptsize/}}}\mathbin{#1}}

\newcommand{\sement}{\leq}
\newcommand{\semequiv}{\simeq}

\newcommand{\bv}{\mathsf{bv}}
\newcommand{\fv}{\mathsf{fv}}
\renewcommand{\emptyset}{⌀}
\newcommand{\subst}[3]{#1 \{ #2 / #3 \}}
\newcommand{\compr}[2]{\left\{#1 ~\middle|~ #2\right\}}
\newcommand{\compl}[1]{\overline{#1}}
\newcommand{\fset}[3]{\{#3\}_{#1}^{#2}}

\newcommand{\hypo}[1]{{\color{hypo} #1}}
\newcommand{\conc}[1]{{\color{conc} #1}}
\newcommand{\dvar}[1]{{\color{dvar} #1}}

\newcommand{\prov}[1]{\sststile{#1}{}}

\newcommand{\dmdual}[1]{\overline{#1}}

% Bubbles

\newcommand{\cham}{\textsc{Cham}}

\newcommand{\bubbleT}[1]{\llparenthesis~#1~\rrparenthesis}
\newcommand{\piq}[1]{\mathbin{\langle #1 \rangle}}

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,fill=white,inner sep=2pt] (char) {#1};}}
\newcommand*\bcircled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,fill=solved,inner sep=2pt] (char) {#1};}}
\newcommand*\gAcircled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,fill=genA,inner sep=2pt] (char) {#1};}}
\newcommand*\gBcircled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,fill=genB,inner sep=2pt] (char) {#1};}}

\newcommand*\fillcircled[2]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,fill=#1,inner sep=2pt] (char) {#2};}}


\newcommand{\bubble}[1]{\color{bubble}\circled{$#1$}}
\newcommand{\cbubble}[1]{\color{conc}\circled{$#1$}}
\newcommand{\hbubble}[1]{\color{hypo}\circled{$#1$}}

\newcommand{\bbubble}[1]{\color{bubble}\bcircled{$#1$}}
\newcommand{\hbbubble}[1]{\color{hypo}\bcircled{$#1$}}
\newcommand{\cbbubble}[1]{\color{conc}\bcircled{$#1$}}

\newcommand{\gAbubble}[1]{\color{bubble}\gAcircled{$#1$}}
\newcommand{\ggAbubble}[1]{\color{black}\gAcircled{$#1$}}
\newcommand{\hgAbubble}[1]{\color{hypo}\gAcircled{$#1$}}
\newcommand{\cgAbubble}[1]{\color{conc}\gAcircled{$#1$}}

\newcommand{\gBbubble}[1]{\color{bubble}\gBcircled{$#1$}}
\newcommand{\hgBbubble}[1]{\color{hypo}\gBcircled{$#1$}}
\newcommand{\cgBbubble}[1]{\color{conc}\gBcircled{$#1$}}

\newcommand{\bsheet}[1]{\colorbox{solved}{$#1$}}
\newcommand{\gAsheet}[1]{\colorbox{genA}{$#1$}}
\newcommand{\gBsheet}[1]{\colorbox{genB}{$#1$}}

\newcommand{\aint}[1]{\llfloor #1 \rrfloor}
\newcommand{\sint}[1]{\left\llbracket #1 \right\rrbracket}
\newcommand{\psint}[1]{\left\llbracket #1 \right\rrbracket^+}
\newcommand{\nsint}[1]{\left\llbracket #1 \right\rrbracket^-}

\newcommand{\identity}{\textsc{$\mathbb{I}$dentity}}
\newcommand{\flow}{\textsc{$\mathbb{F}$low}}
\newcommand{\resource}{\textsc{$\mathbb{R}$esource}}
\newcommand{\heating}{\textsc{$\mathbb{H}$eating}}
\newcommand{\membrane}{\textsc{$\mathbb{M}$embrane}}

\newcommand{\subsol}{\prec}

\newcommand{\deq}{\coloneq}
\newcommand{\ldef}[2]{#1 \deq #2}

\newcommand{\mix}{\,\mathbin{\cupdot}\,}
\newcommand{\J}{\mathbin{\rhd}}
\newcommand{\JB}{\mathbin{\RHD}}

\newcommand{\ltop}{\top}
\newcommand{\lbot}{\bot}
\newcommand{\lmeet}{\land}
\newcommand{\ljoin}{\lor}
\newcommand{\lexp}{\limp}
\newcommand{\lcoexp}{\lsub}

\newcommand{\soldepth}[1]{\left|#1\right|}
\newcommand{\bradepth}[1]{\left|#1\right|}
\newcommand{\soldual}[1]{\overline{#1}}

\newcommand{\Lattice}{\mathcall{L}}
\newcommand{\Heyting}{\mathcall{H}}
\newcommand{\Brouwer}{\mathcall{B}}
\newcommand{\HeytingBrouwer}{\mathcall{H\!B}}
\newcommand{\Boolean}{\mathcall{C}}
\newcommand{\ACVar}{\mathcall{X}}
\newcommand{\sementL}{\sement_{\Lattice}}
\newcommand{\sementH}{\sement_{\Heyting}}
\newcommand{\sementB}{\sement_{\Brouwer}}
\newcommand{\sementHB}{\sement_{\HeytingBrouwer}}
\newcommand{\sementC}{\sement_{\Boolean}}
\newcommand{\sementX}{\sement_{\ACVar}}
\newcommand{\sysB}{\msys{B}}
\newcommand{\sysBH}{\msys{B_{\!\Heyting}}}
\newcommand{\sysBB}{\msys{B_{\!\Brouwer}}}
\newcommand{\sysBHB}{\msys{B_{\!\HeytingBrouwer}}}

\newcommand{\psintAnd}[3]{\bigwedge_{#1 \in #2}{\psint{#3}}}
\newcommand{\psintAndMix}[4]{\psintAnd{#1}{#2}{#1 \mix (#3 \seq #4)}}
\newcommand{\nsintOr}[3]{\bigvee_{#1 \in #2}{\psint{#3}}}
\newcommand{\nsintOrMix}[4]{\nsintOr{#1}{#2}{#1 \mix (#3 \seq #4)}}

\newcommand{\cS}{\mathcal{S}}

\newcommand{\dseq}{\mathbin{\trhd}}
\newcommand{\dtrans}[1]{\begingroup #1 \endgroup^{\scalebox{1.25}{$\bullet$}}}

\newcommand{\pol}[1]{\mathsf{pol}(#1)}

\newcommand{\imps}[1]{\mathrm{imp}(#1)}

% Existential Graphs

\newcommand{\SA}{\small\textsc{SA}}

\newcommand{\psheet}[1]{\color{pbg}{#1}}
\newcommand{\nsheet}[1]{\color{nfg}\colorbox{nbg}{$#1$}}
\newcommand{\pcut}[1]{\color{pfg}\fillcircled{pbg}{\color{pfg}$#1$}}
\newcommand{\ncut}[1]{\color{nfg}\fillcircled{nbg}{\color{nfg}$#1$}}

\newcommand{\opcut}[1]{\color{white}\fillcircled{white}{\color{black}$#1$}}
\newcommand{\oncut}[1]{\color{black}\fillcircled{black}{\color{white}$#1$}}

\newcommand{\atoms}{\mathcal{A}}

\newcommand{\anodes}{\symbf{N_\alpha}}
\newcommand{\agraphs}{\symbf{G_\alpha}}
\newcommand{\bnodes}{\symbf{N_\beta}}
\newcommand{\bgardens}{\symbf{\Gamma_\beta}}
\newcommand{\bgraphs}{\symbf{G_\beta}}

\newcommand{\gdepth}[1]{\left|#1\right|}

\newcommand{\strans}[1]{\begingroup #1 \endgroup^{\scalebox{1.25}{$\bullet$}}}

\newcommand{\itsrc}[1]{\begingroup\setlength{\fboxrule}{0.8pt}\setlength{\fboxsep}{2pt}\color{itsrc}\fbox{\color{black}$#1$}\endgroup}
\newcommand{\itdst}[1]{\colorbox{itdst}{$#1$}}
\newcommand{\ins}[1]{\colorbox{ins}{$#1$}}
\newcommand{\dcut}[1]{\colorbox{dcut}{$#1$}}

\newcommand{\ljustif}{\mathbin{\succeq_0}}
\newcommand{\gjustif}{\mathbin{\succeq}}

\newcommand{\westhook}[2]{
  \node[anchor=east,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.west) {}
}
\newcommand{\easthook}[2]{
  \node[anchor=west,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.east) {}
}
\newcommand{\northhook}[2]{
  \node[anchor=south,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.north) {}
}
\newcommand{\southhook}[2]{
  \node[anchor=north,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.south) {}
}
\newcommand{\northeasthook}[2]{
  \node[anchor=south west,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.north east) {}
}
\newcommand{\northwesthook}[2]{
  \node[anchor=south east,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.north west) {}
}
\newcommand{\southeasthook}[2]{
  \node[anchor=north west,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.south east) {}
}
\newcommand{\southwesthook}[2]{
  \node[anchor=north east,shape=diamond,draw,fill=white,inner sep=1pt] (#1) at (#2.south west) {}
}

\newcommand{\ter}[2]{
\node[isosceles triangle,draw,minimum size=5pt,inner sep=0pt,fill=black] (#1) at (#2) {};
}
\newcommand{\coter}[2]{
\node[isosceles triangle,draw,minimum size=5pt,inner sep=0pt,fill=black,rotate=180] (#1) at (#2) {};
}
\newcommand{\terid}[2]{
\ter{#1}{#2}
\node[inner sep=0] (#1-in-top) at ($(#1.left corner) + (-1,+0.5)$) {};
\node[inner sep=0] (#1-in-bot) at ($(#1.right corner) + (-1,-0.5)$) {};
\node[inner sep=0] (#1-out) at ($(#1.apex) + (1,0)$) {};
\draw (#1.left corner) ..controls (#1.left corner) and ($(#1.left corner) + (0,0.55)$).. (#1-in-top);
\draw (#1.right corner) ..controls (#1.right corner) and ($(#1.right corner) - (0,0.55)$).. (#1-in-bot);
\draw ($(#1.apex) - (0.1,0)$) -- (#1-out);
}
\newcommand{\coterid}[2]{
\coter{#1}{#2}
\node[inner sep=0] (#1-out-top) at ($(#1.left corner) + (+1,-0.5)$) {};
\node[inner sep=0] (#1-out-bot) at ($(#1.right corner) + (+1,+0.5)$) {};
\node[inner sep=0] (#1-in) at ($(#1.apex) - (1,0)$) {};
\draw (#1.left corner) ..controls (#1.left corner) and ($(#1.left corner) - (0,0.55)$).. (#1-out-top);
\draw (#1.right corner) ..controls (#1.right corner) and ($(#1.right corner) + (0,0.55)$).. (#1-out-bot);
\draw ($(#1.apex) + (0.1,0)$) -- (#1-in);
}

\newcommand{\binder}[2]{
  \node[draw,circle,fill=black,inner sep=0,minimum size=3pt] (#1) at (#2) {};
}

% Flowers

\newcommand{\Nature}{\text{\ding{96}}}
\newcommand{\Culture}{\text{\ding{34}}}

\newcommand{\flower}[2]{#1 \csup #2}
\newcommand{\garden}[2]{#1 \cdot #2}

\newcommand{\flowers}{\mathbb{F}}
\newcommand{\gardens}{\mathbb{G}}

\newcommand{\interp}[1]{\llbracket #1 \rrbracket}

\newcommand{\chyp}[2]{#1 \succ #2}

\newcommand{\DrawFlowers}[1]{\directlua{dofile("flower.lua").many({#1})}}

\newcommand{\pissheet}[1]{\colorbox{pistil}{$#1$}}

\newcommand{\bx}{\mathbf{x}}
\newcommand{\by}{\mathbf{y}}
\newcommand{\bz}{\mathbf{z}}

\newcommand{\atomoccs}[1]{\mathcall{A}(#1)}
\newcommand{\vehicle}[1]{\mathcall{V}(#1)}
\newcommand{\anchor}[1]{\vrefl{\mathcall{V}}(#1)}
\newcommand{\lca}[2]{\mathsf{lca}(#1,#2)}

\newcommand{\cinter}{\mathbin{\bowtie}}
\newcommand{\cinterpos}{\mathbin{\stackon[1pt]{$\cinter$}{$\scriptstyle +$}}}
\newcommand{\cinterneg}{\mathbin{\stackon[1pt]{$\cinter$}{$\scriptstyle -$}}}
\newcommand{\sinter}{\mathbin{\hrefl{\propto}}}
\newcommand{\sinterpos}{\mathbin{\stackon[1pt]{$\sinter$}{$\scriptstyle +$}}}
\newcommand{\sinterneg}{\mathbin{\stackon[1pt]{$\sinter$}{$\scriptstyle -$}}}
\newcommand{\justi}{\mathbin{\hookrightarrow}}
\newcommand{\compat}{\mathbin{\da}}

\newcommand{\Action}[1]{\texttt{#1}}
\newcommand{\Proof}{\begingroup \textsc{Proof} \endgroup}
\newcommand{\Edit}{\begingroup \textsc{Edit} \endgroup}
\newcommand{\Navigation}{\begingroup \textsc{Navigation} \endgroup}

% First-order

\newcommand{\vars}{\mathcal{V}}
\newcommand{\fsymbs}{\mathcal{F}}
\newcommand{\psymbs}{\mathcal{P}}
\newcommand{\arity}{\mathsf{ar}}
\newcommand{\dom}{\mathsf{supp}}
\newcommand{\terms}{\mathbb{T}}
\newcommand{\csts}{\mathbb{C}}

\newcommand{\closed}[1]{\underline{#1}}
\newcommand{\restr}[2]{#1 |_{#2}}
\newcommand{\upd}[1]{\mathbin{|_{#1}}}
\newcommand{\update}[3]{#1 \upd{#2} #3}
\newcommand{\idsubst}{\mathsf{1}}
\newcommand{\cstsubst}[1]{\overline{#1}}

\newcommand{\tvec}[1]{\vec{\mathbf{#1}}}

% Kripke

\newcommand{\rewolF}[1]{\text{\ding{95}}(#1)}

\newcommand{\kentails}{\vDash}
\newcommand{\kequiv}{\mathop{\vrefl{{\vDash}}{\vDash}}}

\newcommand{\forces}{\,\Vdash\,}
\newcommand{\nforces}{\,\nVdash\,}
\newcommand{\eforces}[3]{#1\,\Vdash\,#2\,[#3]}
\newcommand{\neforces}[3]{#1\,\nVdash\,#2\,[#3]}
\newcommand{\access}{\leq}

\newcommand{\completion}[1]{\mathsf{Com}(#1)}
\newcommand{\ncompletion}[2]{\mathsf{Com}^{#2}(#1)}


\newcommand{\tT}{\mathcall{T}}
\newcommand{\tU}{\mathcall{U}}

% Actema

\DeclareMathOperator{\rew}{~~\rhd~~}
\DeclareMathOperator{\mrew}{~~\rhd^\ast~~}
\DeclareMathOperator{\link}{\,@\,}
\DeclareMathOperator{\forw}{\,\varoast\,}
\DeclareMathOperator{\back}{\,\varogreaterthan\,}
\DeclareMathOperator{\para}{\,\varobar\,}

\newcommand{\rever}{^*}
\newcommand{\phole}{\square}
\newcommand{\fhole}{\boxdot}
\newcommand{\ifill}[2]{#1\left\{#2\right\}}
\newcommand{\efill}[2]{#1\left[#2\right]}
\newcommand{\lint}[1]{\lfloor#1\rfloor}

\DeclareRobustCommand{\msys}[1]{\begingroup \mathsf{#1} \endgroup}
\DeclareRobustCommand{\sys}[1]{$\msys{#1}$}
\newcommand{\pair}[2]{\left\langle #1, #2 \right\rangle}

\newcommand{\ra}{\rightarrow}
\newcommand{\FV}{\mbox{FV}}
\newcommand{\ocp}{\square_+}
\newcommand{\ocn}{\square_-}
\newcommand{\uA}{\select{A}}
\newcommand{\uB}{\select{B}}
\newcommand{\uC}{\select{C}}
\newcommand{\select}[1]{\fbox{$#1$}}
\newcommand{\stepto}{~~~~\mapsto~~~}
\newcommand{\inv}{\mathsf{inv}}
\newcommand{\uvars}{\mathsf{U}}
\newcommand{\lvar}{l}
\newcommand{\lvarp}{l^+}
\newcommand{\lvarn}{l^-}

\newcommand{\mother}{\mbox{\textsf{mother}}}
\newcommand{\rich}{\mbox{\textsf{Rich}}}
\newcommand{\human}{\mbox{\textsf{Human}}}
\newcommand{\mortal}{\mbox{\textsf{Mortal}}}
\newcommand{\socrates}{\mbox{\textsf{Socrates}}}

\newcommand{\injective}{\mbox{\textsf{injective}}}

\newcommand{\action}[1]{\textsf{#1}}
\newcommand{\process}[1]{\textsf{#1}}
\newcommand{\request}[1]{\texttt{#1}}
\newcommand{\trgoal}[1]{\llbracket #1 \rrbracket}
\newcommand{\traction}[1]{\llparenthesis #1 \rrparenthesis}
\newcommand{\subterms}[1]{\lfloor #1 \rfloor}

\newcommand{\ssreflect}{\textsc{SSReflect}}
\newcommand{\ltac}{$\mathcal{L}_{tac}$}

% \newcommand{\suc}[1]{#1\!\oplus\! 1}
\newcommand{\suc}[1]{S(#1)}

% Type theory

\newcommand{\Prop}{\mathsf{Prop}}