\setchapterpreamble[u]{\margintoc}
\chapter{Interactive sequents}
\labch{app:pba}

\section{Soundness}\labsec{app:dnd-soundness}

\todo{Detailed proofs of all lemmas from \refsec{soundness}.}

\section{Valid Progress}\labsec{vprogress}

\begin{proof}
  Let $\mathcal{L} = B\select{A} \link C\select{A'}$.\\
  \begin{enumerate}
    \setlength{\itemsep}{1em}
    \item By condition~\ref{cond:pol}, we know that a forward linkage cannot
    verify $(\inv(B\square), \inv(C\square)) = (0,0)$, thus $\mathcal{L}$ must
    be a backward linkage. Also $\lvar(B\square)$ and $\lvar(C\square)$ are
    empty, hence by definition~\ref{def:valid-linkage} $A$ and $A'$ are unified
    by an empty substitution, which entails that $A = A'$.

    \item In the following, we show that we can always apply a rewrite rule that
    produces a new, valid linkage $\mathcal{L'}$.
    
    Let $\sigma$ and $\lvar$ be respectively the substitution and
    interleaving of the quantified variables of $B\square$ and $C\square$ given
    by definition \ref{def:valid-linkage}, with $\lvar$ decomposed as $x ::
    \lvar'$.
    
    \begin{itemize}
      \item If $x$ is quantified at the head of either $B\square$ or $C\square$,
        then we apply the associated quantifier rule:

        \begin{description}
          \item[Switch rule (\rnmsf{L\forall s}, \rnmsf{L\exists s},
          \rnmsf{R\forall s}, \rnmsf{R\exists s}, \rnmsf{F\forall s},
          \rnmsf{F\exists s})] Only if $x$ is not in the domain of $\sigma$. In
          forward mode and when $B\square$ binds $x$, one must first apply the
          rule \rnmsf{Fcomm} to put $B\select{A}$ on the right of $\ast$, so
          that the switch rule is applicable. Now we show that $\mathcal{L'}$ is
          valid:

          \begin{enumerate}
            \setlength{\itemsep}{0.8em}
            \renewcommand{\labelenumii}{\theenumii}
            \renewcommand{\theenumii}{\arabic{enumii}.}

            \item Trivial since none of the switch rules changes the number of
            inversions.

            \item For each switch rule we can show, using the fact that $x$ is
            not in the domain of $\sigma$, that $\uvars(\mathcal{L'}) =
            \uvars(\mathcal{L})$. Since the selected formulas $A$ and $A'$ stay
            untouched by the reduction, we can choose $\sigma$ as a valid
            unifier that ranges over $\uvars(\mathcal{L'})$.
            
            \item In all switch rules, we have $\lvar(\mathcal{L'}) = \lvar'$
            because the quantifier of $x$ is moved in the outer context of the
            linkage. Thus we can just take $\lvar'$ as interleaving, and the
            condition will still be verified because $\lvar'$ is a sublist of
            $\lvar$.
          \end{enumerate}

          \item[Instantiation rule (\rnmsf{L\forall i}, \rnmsf{R\exists i},
          \rnmsf{F\forall i})] Only if $x$ is instantiated by $\sigma$, using
          $\sigma(x)$ as witness. Again one might need to apply \rnmsf{Fcomm}
          first. Then we check the validity of $\mathcal{L'}$:

          \begin{enumerate}
            \setlength{\itemsep}{0.8em}
            \renewcommand{\labelenumii}{\theenumii}
            \renewcommand{\theenumii}{\arabic{enumii}.}
            
            \item Trivial since none of the instantiation rules changes the
            number of inversions.

            \item For each instantiation rule we can show, using the fact that
            $x$ is instantiated by $\sigma$, that $\uvars(\mathcal{L'}) =
            \uvars(\mathcal{L}) \setminus \{x\}$. Then we take as unifier
            $\sigma$ where the binding for $x$ is removed, written $\sigma
            \setminus x$.\\

            Now we need to make sure that $\sigma \setminus x$ is indeed a
            unifier for the selected formulas. We consider only the case where
            $B\square$ binds $x$, the proof being exactly symmetrical when
            $C\square$ binds $x$. Let $B_0\square$ be the direct subcontext of
            $B\square$, that is $B\square$ without the head quantifier binding
            $x$. \\

            First we can assert that $B_0\select{A}[x \setminus \sigma(x)] =
            B_0[x \setminus \sigma(x)]\select{A[x \setminus \sigma(x)]}$.
            Indeed, condition 3 of definition \ref{def:valid-linkage} guarantees
            that for any free variable $y$ of $\sigma(x)$, $y \not\in
            \lvar(B_0\square)$, and thus the above instantiation can propagate
            safely to $A$ without capture. To convince yourself that $y \not\in
            \lvar(B_0\square)$, suppose the contrary. Then $y \in
            \lvar(B\square)$, and by condition 3 $y$ must be placed before $x$
            in $\lvar$. But this is impossible since $x$ is the first element of
            $\lvar$!\\
            
            So we know that the selected formula on the left of $\mathcal{L'}$
            is $A[x \setminus \sigma(x)]$, while it is still $A'$ on the right.
            Thus it only remains to show that
            $$A[x \setminus \sigma(x)][\sigma \setminus x] = A'[\sigma \setminus
            x].$$ On the left we have by definition that $A[x \setminus
            \sigma(x)][\sigma \setminus x] = A[\sigma]$, and on the right we
            have $A'[\sigma \setminus x] = A'[\sigma]$ because $x$ cannot occur
            in $A'$ since it is bound in $B_0\square$ (here we rely on the
            Barendregt convention).

            \item In all instantiation rules, we have $\lvar(\mathcal{L'}) =
            \lvar'$ because the quantifier of $x$ is removed by the
            instantiation. Thus we can again take $\lvar'$ as interleaving.
          \end{enumerate}
          
        \end{description}

      \item If $x$ is not quantified at the head of $B$ or $C$, then either both
      heads are propositional connectives, or one is a propositional connective
      and the other is empty. In boths cases we can choose a backward (resp.
      forward) rule of the form \rnmsf{B\circ_i} (resp. \rnmsf{F\circ_i}), where
      $\circ$ is the connective, and $i$ the index of the direct subcontext
      where $A$ or $A'$ occurs. Again we check the conditions of definition
      \ref{def:valid-linkage}:
      
      \begin{enumerate}
        \setlength{\itemsep}{0.8em}
        \renewcommand{\labelenumii}{\theenumii}
        \renewcommand{\theenumii}{\arabic{enumii}.}
            
        \item In most rules the number of inversions stays unchanged. The only
        exceptions are \rnmsf{R\!\!\limp_1} and \rnmsf{F\!\!\limp_1}, which
        decrease the number of inversions of the right context by $1$. Thus for
        \rnmsf{R\!\!\limp_1} which is backward, we start with either $(1,1)$ or
        $(0,2)$, and obtain $(1,0)$ or $(0,1)$ which are valid according to
        condition \ref{cond:pol} since $\mathcal{L'}$ is forward. Conversely for
        \rnmsf{F\!\!\limp_1} which is forward, we must start with $(1,0)$, and
        obtain $(0,0)$ which is valid since $\mathcal{L'}$ is backward.

        \item Since we do not deal with quantifiers, we can just take the same
        unifier $\sigma$.

        \item Same here, we take the same interleaving $l$.
      \end{enumerate}
    \end{itemize} 
  \end{enumerate}
\end{proof}

\section{Focusing}\labsec{focusing}

\todo{TODO}

\sidenote{There are 7 invertible rules, and 23 non-invertible
    rules to consider in \reffig{DISL} (we exclude the {\rnmsf{id}} and
    {\rnmsf{Fcomm}} rules).}

\section{Completeness}\labsec{app:dnd-completeness}

\todo{TODO}