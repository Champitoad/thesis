\subsection{Heyting and Brouwer algebras}

\begin{figure*}
  \tikzfig{1}{0.83}{venn-algebras}
  \caption{Relationship between the various algebras interpreting system \sys{B}}
  \labfig{venn-algebras}
\end{figure*}

We are now going to prove the soundness of system \sys{B} with respect to
various classes of \emph{algebras}. While the full system is classical and thus
sound only in \emph{Boolean} algebras, most rules are sound in larger classes of
algebras, namely: \emph{Heyting} algebras for intuitionistic logic,
\emph{Brouwer} algebras for dual-intuitionistic logic, and
\emph{Heyting-Brouwer} algebras for bi-intuitionistic logic. These 4 classes are
all instances of \emph{bounded lattices}, and their relationship is summarized
in the Venn diagram of \reffig{venn-algebras}.

First we recall the definitions of the various algebras:

\begin{definition}[Bounded lattice]\labdef{bounded-lattice}
  A \emph{bounded lattice} is a structure $(\mathcal{A}, \sement, \ltop, \lbot, \lmeet,
  \ljoin)$ such that:
  \begin{itemize}
    \item $(\mathcal{A}, \sement)$ is a partial order, i.e. for every $a, b, c
    \in \mathcal{A}$ we have:
      \begin{itemize}
        \item $a \sement a$;
        \item if $a \sement b$ and $b \sement a$ then $a = b$;
        \item if $a \sement b$ and $b \sement c$ then $a \sement c$.
      \end{itemize}
    \item $\lbot$ and $\ltop$ are respectively the smallest and greatest
    elements of $(\mathcal{A}, \sement)$, i.e. for every $a \in \mathcal{A}$ we
    have $\bot \sement a$ and $a \sement \ltop$;
    \item For every pair of elements $a, b \in \mathcal{A}$, $a \ljoin b$ is
    their join (least upper bound) and $a \lmeet b$ their meet (greatest lower
    bound), that is:
    \begin{itemize}
      \item $a \sement a \ljoin b$, $b \sement a \ljoin b$ and $a \ljoin b \sement c$ for all $c \in \mathcal{A}$ s.t. $a \sement c$ and $b \sement c$;
      \item $a \lmeet b \sement a$, $a \lmeet b \sement b$ and $c \sement a \lmeet b$ for all $c \in \mathcal{A}$ s.t. $c \sement a$ and $c \sement b$.
    \end{itemize}
  \end{itemize}
\end{definition}

\begin{remark}
  As mentioned in the introduction, we only conjecture the soundness of rules
  for quantifiers: this would require considering \emph{complete} lattices, i.e.
  with meets and joins for arbitrary sets rather than just pairs\sidenote{see
  for instance section 4 of \cite{forster_completeness_2021} for a concise
  treatment of the soundness and completeness of intuitionistic and classical
  natural deduction for first-order logic with respect to algebraic semantics.}.
\end{remark}

As the notation strongly suggests, the greatest and smallest elements $\top$ and
$\bot$ will model respectively truth and falsehood, while the meet $\lmeet$ and
join $\ljoin$ will model conjunction and disjunction. In fact the conditions of
\refdef{bounded-lattice} are very close to the rules of natural deduction for
these connectives, by replacing the sequent operator $\seq$ with the partial
order relation $\sement$. The same idea can be applied to the implication
connective, and adding a corresponding \emph{exponential} operation $\lexp$
indeed gives the definition of a Heyting algebra:

\begin{definition}[Heyting algebra]
  A \emph{Heyting algebra} is a structure $(\mathcal{A}, \sement, \ltop, \lbot,
  \lmeet, \ljoin, \lexp)$ such that $(\mathcal{A}, \sement, \ltop, \lbot,
  \lmeet, \ljoin)$ is a bounded lattice and for every pair $a, b \in
  \mathcal{A}$, the \emph{exponential} $a \lexp b$ is the greatest element of
  the set $\compr{c \in \mathcal{A}}{c \lmeet a \sement b}$. That is, $(a \lexp
  b) \lmeet a \sement b$ and $c \sement a \lexp b$ for all $c \in \mathcal{A}$
  s.t. $c \lmeet a \sement b$.
\end{definition}

By dualizing this definition, we get a \emph{co-exponential} operation $\lcoexp$
that models the exclusion connective, and thus dual-intuitionistic logic in
so-called Brouwer algebras:

\begin{definition}[Brouwer algebra]
  A \emph{Brouwer algebra} is a structure $(\mathcal{A}, \sement, \ltop, \lbot,
  \lmeet, \ljoin, \lcoexp)$ such that $(\mathcal{A}, \sement, \ltop, \lbot,
  \lmeet, \ljoin)$ is a bounded lattice and for every pair $a, b \in
  \mathcal{A}$, the \emph{co-exponential} $a \lcoexp b$ is the smallest element
  of the set $\compr{c \in \mathcal{A}}{b \sement a \ljoin c}$. That is, $b
  \sement a \ljoin (b \lcoexp a)$ and $b \lcoexp a \sement c$ for all $c \in
  \mathcal{A}$ s.t. $b \sement a \ljoin c$.
\end{definition}

Then we can model bi-intuitionistic logic, which comprises both implication and
exclusion, by just taking pairs of a Heyting and a Brouwer algebra on the same
bounded lattice:

\begin{definition}[Heyting-Brouwer algebra]
  A \emph{Heyting-Brouwer algebra} is a structure $(\mathcal{A}, \sement, \ltop,
  \lbot, \lmeet, \ljoin, \lexp, \lcoexp)$ such that $(\mathcal{A}, \sement,
  \ltop, \lbot, \lmeet, \ljoin, \lexp)$ is a Heyting algebra and $(\mathcal{A},
  \sement, \ltop, \lbot, \lmeet, \ljoin, \lcoexp)$ is a Brouwer algebra.
\end{definition}

Finally, we recover classical logic by collapsing exponentials and
co-exponentials to their classical definitions, giving a characterization of
Boolean algebras:

\begin{definition}\labdef{boolean-algebra}
  A \emph{Boolean algebra} is a Heyting-Brouwer algebra $(\mathcal{A}, \sement,
  \ltop, \lbot, \lmeet, \ljoin, \lexp, \lcoexp)$ such that for every $a, b \in
  \mathcal{A}$, $a \lexp b = (\ltop \lcoexp a) \ljoin b$ and $a \lcoexp b = a
  \lmeet (b \lexp \bot)$.
\end{definition}

\begin{remark}
\refdef{boolean-algebra} can be shown equivalent to more
usual definitions of Boolean algebras, that are based only on lattice operations
and a primitive complement operation modelling negation; but including the proof
here would lead us out of the scope of this chapter.
% \todo{Proof in appendix?}
\end{remark}

In the rest of this chapter, we will freely assimilate formulas and their
interpretation in the various algebras. Indeed, since we only consider the
abstract classes of all algebras and never deal with a particular instance,
they will stand in perfect bijection.

\begin{definition}[Semantic entailment]
  We will write $A \sement_{\mathcall{X}} B$ (resp. $A \semequiv_{\mathcall{X}}
  B$) to express that $A \sement B$ (resp. $A \sementX B$ and $B \sementX A$) in
  every algebra of the class $\mathcall{X}$. More precisely, $\mathcall{X}$ can
  be one of $\Lattice$, $\Heyting$, $\Brouwer$, $\HeytingBrouwer$ or $\Boolean$,
  which stand respectively for bounded lattices, Heyting, Brouwer,
  Heyting-Brouwer and Boolean algebras. We will write $A \sement B$ (resp. $A
  \semequiv B$) as a shorthand for $A \sementH B$ (resp. $A \semequiv_{\Heyting}
  B$).
\end{definition}

\subsection{Duality}

We now prove a number of lemmas that characterize \emph{duality} both
semantically, typically between Heyting and Brouwer algebras, and syntactically
in the rules of system $\sysB$. This will be useful later on to shorten some
proofs.

\begin{definition}[Dual formula]\labdef{dual-formula}
  The \emph{dual formula} $\soldual{A}$ of a formula $A$ is defined recursively
  as follows:
  \begin{align*}
    \soldual{a} &= a &\\
    \soldual{\top} &= \bot &
    \soldual{\bot} &= \top \\
    \soldual{A \land B} &= \soldual{A} \lor \soldual{B} &
    \soldual{A \lor B} &= \soldual{A} \land \soldual{B} \\
    \soldual{A \limp B} &= \soldual{B} \lsub \soldual{A} &
    \soldual{A \lsub B} &= \soldual{B} \limp \soldual{A}
  \end{align*}
\end{definition}

\begin{fact}[Duality]\labfact{duality}
  \sbr
  \begin{itemize}
    \item $A \sementH B$ if and only if $\soldual{B} \sementB \soldual{A}$
    \item $A \sementB B$ if and only if $\soldual{B} \sementH \soldual{A}$
    \item $A \sementX B$ if and only if $\soldual{B} \sementX \soldual{A}$ when $\ACVar
    \in \{\HeytingBrouwer, \Boolean\}$.
  \end{itemize}
\end{fact}

We omit the proof of \reffact{duality}, but this can easily be obtained from the
soundness and completeness of a symmetric sequent calculus for bi-intuitionistic
logic, see for instance Lemma 2 of \sidecite{restall_extending_1997}.

\begin{definition}[Dual solution]\labdef{dual-solution}
  The \emph{dual solution} $\soldual{S}$ of a solution $S$ is defined
  mutually recursively as follows:
  \begin{align*}
    \soldual{\Gamma \J \Delta} &= \soldual{\Delta} \mathbin{\soldual{\J}} \soldual{\Gamma} &
    \soldual{S_1 \sep \ldots \sep S_n} &= \soldual{S_1} \sep \ldots \sep \soldual{S_n} \\
    \soldual{A} &= \soldual{A} &
    \soldual{I_1, \ldots, I_n} &= \soldual{I_1}, \ldots, \soldual{I_n} \\
    \soldual{\seq} &= {\seq} &
    \soldual{\piq{\cS}} &= \piq{\soldual{\cS}}
  \end{align*}
  For solution contexts, the hole is self-dual: $\soldual{\hole} = \hole$. This
  entails in particular that $\soldual{S}\select{\soldual{T}} =
  \soldual{S\select{T}}$.
\end{definition}

Graphically, the dual of a solution $S$ is $S$ where the colors of items have
been swapped --- i.e. blue items become red and red items become blue --- and
formulas have been dualized (\refdef{dual-formula}).

\begin{definition}\labdef{item-depth}
  The \emph{depth} $\soldepth{I}$ of an item $I$ is defined recursively as
  follows:
  \begin{align*}
    \soldepth{A} &= 0 \\
    \soldepth{\Gamma \seq \Delta} &= 1 + \max_{J \in \Gamma \cup \Delta}{\soldepth{J}} \\
    \soldepth{\Gamma \piq{\cS} \Delta} &= 1 + \max_{J \in \Gamma \cup \cS \cup \Delta}{\soldepth{J}}
  \end{align*}
\end{definition}

\begin{lemma}[Involutivity]\lablemma{involutivity}
  $\soldual{\soldual{I}} = I$.
\end{lemma}
\begin{proof}
  By recurrence on $\soldepth{I}$.
  \begin{itemize}
    \item[\textbf{Formula}] Suppose $I = A$. Then we conclude by a
    straightforward induction on $A$.
    \item[\textbf{Open solution}] Suppose $I = \Gamma \seq \Delta$. Then by
    definition we have $\soldual{\soldual{\Gamma \seq \Delta}} =
    \soldual{\soldual{\Delta} \seq \soldual{\Gamma}} =
    \soldual{\soldual{\Gamma}} \seq \soldual{\soldual{\Delta}}$, and we conclude
    by IH.
    \item[\textbf{Closed solution}] Suppose $I = \Gamma \piq{\cS}
    \Delta$. Then by definition we have $\soldual{\soldual{\Gamma
    \piq{\cS} \Delta}} = \soldual{\soldual{\Delta}
    \piq{\soldual{\cS}} \soldual{\Gamma}} =
    \soldual{\soldual{\Gamma}} \piq{\soldual{\soldual{\cS}}}
    \soldual{\soldual{\Delta}}$, and we conclude by IH.
  \end{itemize}
\end{proof}

\begin{lemma}[Local rule duality]\lablemma{local-rule-duality}
  If $S \lstep T$ then $\soldual{S} \lstep \soldual{T}$.
\end{lemma}
\begin{proof}
  There is a bijection among the rules of system \sys{B}, that matches each rule
  $\irule{r}{S}{T}$ to its dual $\irule{\soldual{r}}{\soldual{S}}{\soldual{T}}$.
  By involutivity (\reflemma{involutivity}), this bijection is self-inverse:
  $\soldual{\soldual{r}} = r$. It is most easily observed in
  the graphical presentation of the rules (\reffig{graphical-B}), where looking
  for the dual rule boils down to swapping red and blue (and mirroring logical
  connectives). The mapping goes as follows:
  \begin{mathpar}
  \begin{array}{r@{\quad\leftrightarrow\quad}l}
    \mathsf{i{\da}} & \mathsf{i{\da}} \\
    \mathsf{i{\ua}} & \mathsf{i{\ua}} \\
  \end{array}
  \and
  \begin{array}{r@{\quad\leftrightarrow\quad}l}
    \mathsf{w{-}} & \mathsf{w{+}} \\
    \mathsf{c{-}} & \mathsf{c{+}} \\
  \end{array}
  \\
  \begin{array}{r@{\quad\leftrightarrow\quad}l}
    \mathsf{f{-}} & \mathsf{f{+}} \\
    \mathsf{f{-}{+}{\da}} & \mathsf{f{+}{-}{\da}} \\
    \mathsf{f{-}{-}{\ua}} & \mathsf{f{+}{+}{\ua}} \\
    \mathsf{f{-}{+}{\ua}} & \mathsf{f{+}{-}{\ua}} \\
    \mathsf{f{-}{-}{\da}} & \mathsf{f{+}{+}{\da}} \\
  \end{array}
  \and
  \begin{array}{r@{\quad\leftrightarrow\quad}l}
    \mathsf{p} & \mathsf{p} \\
    \mathsf{p{-}} & \mathsf{p{+}} \\
    \mathsf{a} & \mathsf{a} \\
    \mathsf{a{-}} & \mathsf{a{+}} \\
  \end{array}
  \\
  \begin{array}{r@{\quad\leftrightarrow\quad}l}
    \top{-} & \bot{+} \\
    \bot{-} & \top{+} \\
    \land{-} & \lor{+} \\
    \lor{-} & \land{+} \\
    {\limp}{-} & {\lsub}{+} \\
    {\lsub}{-} & {\limp}{+} \\
    \forall{-} & \exists{+} \\
    \exists{-} & \forall{+} \\
  \end{array}
  \end{mathpar}
  Notice that some rules are self-dual, namely the identity rules
  {\rnmsf{i{\da}}} and {\rnmsf{i{\ua}}}, and the membrane rules
  {\rnmsf{p}} and {\rnmsf{a}}.
\end{proof}

\begin{lemma}[Rule duality]\lablemma{rule-duality}
  If $S \step T$ then $\soldual{S} \step \soldual{T}$.
\end{lemma}
\begin{proof}
  Let $U\hole$, $S_0$ and $T_0$ such that $S = U\select{S_0}$, $T =
  U\select{T_0}$ and $S_0 \lstep T_0$. By \reflemma{local-rule-duality} we have
  $\soldual{S_0} \lstep \soldual{T_0}$, and thus
  $\soldual{U}\select{\soldual{S_0}} \step \soldual{U}\select{\soldual{T_0}}$,
  or equivalently $\soldual{U\select{S_0}} \step \soldual{U\select{T_0}}$.
\end{proof}

\begin{lemma}[Interpretation duality]\lablemma{int-duality}
  $\soldual{\psint{I}} = \nsint{\soldual{I}}$ and $\soldual{\nsint{I}} =
  \psint{\soldual{I}}$.
\end{lemma}
\begin{proof}
  By a straightforward recurrence on $\soldepth{I}$.
\end{proof}

\begin{lemma}\lablemma{int-invert}
  $\psint{\soldual{S}} \sementX \psint{\soldual{T}}$ if and only if $\nsint{T} \sementX
  \nsint{S}$ when $\ACVar \in \{\HeytingBrouwer, \Boolean\}$.
\end{lemma}
\begin{proof}
  By duality (\reffact{duality}) we have $\soldual{\psint{\soldual{T}}} \sementX
  \soldual{\psint{\soldual{S}}}$, and then by \reflemma{int-duality}
  $\nsint{\soldual{\soldual{T}}} \sementX \nsint{\soldual{\soldual{S}}}$. We
  conclude by involutivity (\reflemma{involutivity}).
\end{proof}

\subsection{Local soundness}

In the following we give a number of (in)equalities that hold in the various
classes of algebras. They can easily be checked by building derivations in an
adequate sequent calculus.

\begin{fact}[Commutativity]\labfact{lattice-commutativity}
  $A \lor B \semequiv_{\Lattice} B \lor A$ and $A \land B \semequiv_{\Lattice} B \land A$.
\end{fact}

\begin{fact}[Idempotency]\labfact{idempotency}
  $A \lor A \semequiv_{\Lattice} A$ and $A \land A \semequiv_{\Lattice} A$.
\end{fact}

\begin{fact}[Currying]\labfact{currying}
  \begin{align*}
    A \limp (B \limp C) &\semequiv (A \land B) \limp C \\
    (A \lsub B) \lsub C &\semequiv_{\Brouwer} A \lsub (B \lor C)
  \end{align*}
\end{fact}

\begin{fact}[Distributivity]\labfact{distributivity}
  \begin{align*}
    A \land (B \lor C) &\semequiv_{\Lattice} (A \land B) \lor (A \land C) \\
    A \lor (B \land C) &\semequiv_{\Lattice} (A \lor B) \land (A \lor C) \\
    A \limp B \land C &\semequiv (A \limp B) \land (A \limp C) \\
    A \lor B \limp C &\semequiv (A \limp B) \land (A \limp C) \\
    A \lor B \lsub C &\semequiv_{\Brouwer} (A \lsub B) \lor (A \lsub C) \\
    A \lsub B \land C &\semequiv_{\Brouwer} (A \lsub B) \lor (A \lsub C)
  \end{align*}
\end{fact}

\begin{fact}[Weak distributivity]\labfact{weakdistrib}
  \begin{align*}
    (A \limp B) \lor C &\sement A \limp (B \lor C) \\
    A \limp (B \lor C) &\sementC (A \limp B) \lor C \\
    (A \land B) \lsub C &\sementB A \land (B \lsub C) \\
    A \land (B \lsub C) &\sementC (A \land B) \lsub C
  \end{align*}
\end{fact}

\begin{fact}\labfact{gencut}
  \begin{align*}
  (A \lor B) \land (C \limp D) &\sement (A \limp C) \limp (B \lor D) \\
  (A \lor B) \land (C \limp D) &\sementHB (A \lsub C) \lor (B \lor D) \\
  (A \lor B) \land (A \limp B) &\semequiv B
  \end{align*}
\end{fact}

\begin{fact}\labfact{impsub}
  $(A \lsub B) \limp C \sementHB A \limp B \lor C$.
\end{fact}

The following definition will be used pervasively to reason by induction on the
tree structure induced by branching operators:

\begin{definition}
  The \emph{depth} $\bradepth{\J}$ of a branching operator $\J$ is defined
  recursively as follows:
  \begin{align*}
    \bradepth{\seq} &= 0 \\
    \bradepth{\piq{\cS}} &= 1 + \max_{S \in \cS}{\bradepth{S}}
  \end{align*}
\end{definition}

% \begin{lemma}\lablemma{bubbles-multiweak}
%   $\psint{\Gamma \seq \Delta} \sement \psint{\Gamma', \Gamma \seq \Delta, \Delta'}$.
% \end{lemma}
% \begin{proof}
%   $$
%   \begin{array}{rcll}
%     \psint{\Gamma \seq \Delta}
%     &=& \nsint{\Gamma} \limp \psint{\Delta} & \\
%     &\sement& \nsint{\Gamma'} \wedge \nsint{\Gamma} \limp \psint{\Delta}} &\text{(Weakening)} \\
%     &=& \psint{\Gamma', \Gamma \seq \Delta, \Delta'} & \\
%   \end{array}
%   $$
% \end{proof}

% \begin{lemma}[Sharing]
%   $\psint{\Gamma \seq \Delta} \sement \psint{\Gamma \piq{\cS} \Delta}$.
% \end{lemma}
% \begin{proof}
%   Let $\cS = S_1 \sep \ldots \sep S_n$. We proceed by recurrence on
%   $\bradepth{\piq{\cS}}$.
%   \begin{itemize}proof
%     \item[\bcase] Suppose $\bradepth{\piq{\cS}} = 1$, and
%     let $1 \leq i \leq n$. Then we know that $S_i = \Gamma_i \seq \Delta_i$, and
%     by \reflemma{bubbles-multiweak} we get $\psint{\Gamma \seq \Delta} \sement
%     \psint{S_i \mix (\Gamma \seq \Delta)}$. Thus we have
%     $$
%     \begin{array}{rcll}
%       \psint{\Gamma \seq \Delta}
%       &\sement& \bigwedge_{1 \leq i \leq n}{\psint{S_i \mix (\Gamma \seq \Delta)}} & \\
%       &=& \psint{\Gamma \piq{\cS} \Delta}
%     \end{array}
%     $$
%     \item[\rcase] Suppose $\bradepth{\piq{\cS}} > 1$.

%   \end{itemize}
% \end{proof}

Now we can give a few lemmas that generalize some semantic (in)equalities to the
interpretation of solutions with arbitrary branching operators. All detailed
proofs are available in appendix (\refsec{app:bubbles-soundness}).

\begin{lemma}[Generalized weakening]\lablemma{bubbles-weakening}
  $\psint{S} \sement \psint{S \mix (\Gamma \seq \Delta)}$.
\end{lemma}
\begin{proof}
  By recurrence on $\bradepth{\J}$, with $S = \Gamma' \J \Delta'$.
\end{proof}

\begin{lemma}[Generalized contraction]\lablemma{bubbles-contraction}
  $\psint{S \mix (\seq I, I)} \semequiv \psint{S \mix (\seq I)}$ and
  $\psint{S \mix (I, I \seq)} \semequiv \psint{S \mix (I \seq)}$.
\end{lemma}
\begin{proof}
  By recurrence on $\bradepth{\J}$, with $S = \Gamma \J \Delta$.
\end{proof}

\begin{lemma}[Generalized weak distributivity]\lablemma{bubbles-weakdistrib}
  \begin{align}
    \psint{\Gamma \J \Delta} \lor \psint{I} &\sement \psint{\Gamma \J I, \Delta} \label{eqn:weakdistrib-one} \\
    \psint{\Gamma \J I, \Delta} &\sementC \psint{\Gamma \J \Delta} \lor \psint{I} \label{eqn:weakdistrib-two} \\
    \nsint{\Gamma, I \J \Delta} &\sementB \nsint{I} \land \nsint{\Gamma \J \Delta} \label{eqn:weakdistrib-three} \\
    \nsint{I} \land \nsint{\Gamma \J \Delta} &\sementC \nsint{\Gamma, I \J \Delta} \label{eqn:weakdistrib-four}
  \end{align}
\end{lemma}
\begin{proof}
  (\ref{eqn:weakdistrib-one}) holds by recurrence on $\bradepth{\J}$, using the
  corresponding inequality from \reflemma{weakdistrib}. The proof of
  (\ref{eqn:weakdistrib-two}) is the same, except that we use the converse
  inequality of \reffact{weakdistrib} that holds in Boolean algebras.
  (\ref{eqn:weakdistrib-three}) and (\ref{eqn:weakdistrib-four}) hold by duality
  from (\ref{eqn:weakdistrib-one}) and (\ref{eqn:weakdistrib-two}).
\end{proof}

\begin{lemma}[Generalized currying]\lablemma{bubbles-currying}
  \begin{align}
    \psint{\Gamma, I \J \Delta} &\semequiv \nsint{I} \limp \psint{\Gamma \J \Delta} \label{eqn:currying-one} \\
    \nsint{\Gamma \J I, \Delta} &\semequiv_{\Brouwer} \nsint{\Gamma \J \Delta} \lsub \psint{I} \label{eqn:currying-two}
  \end{align}
\end{lemma}
\begin{proof}
  (\ref{eqn:currying-one}) holds by recurrence on $\bradepth{\J}$, and
  (\ref{eqn:currying-two}) by duality.
\end{proof}

% \begin{lemma}[Mix]\lablemma{bubbles-mix}
%   $\psint{S} \land \psint{T} \sement \psint{S \mix T}$.
% \end{lemma}

% \begin{lemma}\lablemma{bubbles-piq}
%   $\psint{S \mix T} \sement \psint{S \mix \piq{T}}$.
% \end{lemma}

Lastly, we mention a technical property of rules that will be necessary for the
final proof of soundness to go through:

\begin{fact}[Top-level genericity]\labfact{bubbles-top-level}
  If $S \lstep T$, then $S \mix (\Gamma \seq \Delta) \lstep T \mix (\Gamma \seq \Delta)$.
\end{fact}

All the previous facts and lemmas can now be used to prove \emph{local
soundness}, i.e. that the interpretation of each rule of system $\sysB$ maps to
an (in)equality in some class of algebras:

\begin{lemma}[Local soundness]\lablemma{bubbles-local-soundness}
  
  If $S \lstep T$ then $\psint{T \mix (\Gamma \seq \Delta)} \sementC \psint{S
  \mix (\Gamma \seq \Delta)}$.
  % and $\nsint{S \mix (\Gamma \seq \Delta)} \sement
  % \nsint{T \mix (\Gamma \seq \Delta)}$.
\end{lemma}
\begin{proof}
  $S \lstep T$ implies $\psint{T} \sementC \psint{S}$, which is shown by
  inspection of each rule of system \sys{B} (see \refsec{bubbles-soundness}).
  That we can mix an arbitrary top-level context $\Gamma \seq \Delta$ into $S$
  and $T$ follows from \reffact{bubbles-top-level}.
\end{proof}

Since some rules only hold classically, the statement for the full system is
relative to Boolean algebras. But from the detailed proof in
\refsec{app:bubbles-soundness}, we can identify two fragments $\sysBH$ and
$\sysBHB$ of system $\sysB$ that are sound with respect to Heyting and
Heyting-Brouwer algebras:

\begin{corollary}\label{cor:lsoundness}
  Let
  \begin{align*}
    \sysBHB &\defeq \sysB \setminus \{\rsf{f{-}{+}{\ua}}, \rsf{f{+}{+}{\da}}, \rsf{f{+}{-}{\ua}}, \rsf{f{-}{-}{\da}}\} \\
    \sysBH &\defeq \sysBHB \setminus \{\rsf{f{+}{-}{\da}, \rsf{f{-}{-}{\ua}, \rsf{{\lsub}{-}}, \rsf{{\lsub}{+}}}}\}
  \end{align*}
  Then we have:
  \begin{itemize}
    \item $S \lstepsys{\sysBH} T$ implies $\psint{T} \sement \psint{S}$
    \item $S \lstepsys{\sysBHB} T$ implies $\psint{T} \sementHB \psint{S}$
    % \item $S \lstepsys{\text{\sysB}} T$ implies $\psint{T} \sementC \psint{S}$
  \end{itemize}
\end{corollary}

In order to get the last missing fragment $\sysBB$ sound with respect to Brouwer
algebras, we need dual lemmas that are relative to the negative interpretation
$\nsint{\cdot}$ instead of the positive interpretation $\psint{\cdot}$, since
implication is replaced by exclusion. To avoid verbosity, we only formulate the
main lemma, and assume that its proof will go through mechanically:

\begin{lemma}[Local co-soundness]\lablemma{bubbles-local-cosoundness}
  If $S \lstep T$ then $\nsint{S \mix (\Gamma \seq \Delta)} \sementC \nsint{T
  \mix (\Gamma \seq \Delta)}$.
\end{lemma}

Then from the (assumed) proof of \reflemma{bubbles-local-cosoundness} we get:
\begin{corollary}\label{cor:lcosoundness}
  Let $\sysBB \defeq \sysBHB \setminus \{\rsf{f{-}{+}{\da}},
  \rsf{f{+}{+}{\ua}}, \rsf{{\limp}{-}}, \rsf{{\limp}{+}}\}$. Then $S
  \lstepsys{\sysBB} T$ implies $\nsint{S} \sementB \nsint{T}$.
\end{corollary}

The full situation is summarized in \reffig{venn-algebras}.

\subsection{Contextual soundness}

\begin{lemma}[Functoriality]\lablemma{bubbles-functoriality}
  Let $\ACVar \in \{\Heyting, \HeytingBrouwer, \Boolean\}$.
  \sbr
  \begin{itemize}
    \item $\psint{I} \sementX \psint{J}$ implies $\psint{(\seq I) \mix S} \sementX
    \psint{(\seq J) \mix S}$
    % \item $\nsint{I} \sementX \nsint{J}$ implies $\nsint{(\seq I) \mix S} \sementX
    % \nsint{(\seq J) \mix S}$
    \item $\nsint{J} \sementX \nsint{I}$ implies $\psint{(I \seq) \mix S}
    \sementX \psint{(J \seq) \mix S}$
    % \item $\psint{J} \sementX \psint{I}$ implies $\nsint{(I
    % \seq) \mix S} \sementX \nsint{(J \seq) \mix S}$
  \end{itemize}
\end{lemma}
\begin{proof}
  Let $S = \Gamma \J \Delta$. We proceed by recurrence on $\bradepth{\J}$.
  \begin{itemize}
    \item[\bcase] Suppose $\bradepth{\J} = 0$. Then $\J = {\seq}$,
    and we have
    $$
    \begin{array}{rcll}
      \psint{(\seq I) \mix S}
      &=& \psint{\Gamma \seq I, \Delta} &\\
      &=& \nsint{\Gamma} \limp \psint{I} \lor \psint{\Delta} &\\
      &\sementX& \nsint{\Gamma} \limp \psint{J} \lor \psint{\Delta} &\text{(Hypothesis)}\\
      &=& \psint{\Gamma \seq J, \Delta} &\\
      &=& \psint{(\seq J) \mix S} &
    \end{array}
    $$
    $$
    \begin{array}{rcll}
      \psint{(I \seq) \mix S}
      &=& \psint{\Gamma, I \seq \Delta} &\\
      &=& \nsint{\Gamma} \land \nsint{I} \limp \psint{\Delta} &\\
      &\sementX& \nsint{\Gamma} \land \nsint{J} \limp \psint{\Delta} &\text{(Hypothesis)} \\
        % &\begin{array}{rl}
        %    &\text{Contravariant functoriality of $\_{\limp}$} \\
        %   +&\text{Functoriality of $\_{\lor}$} \\
        %   +&\text{Hypothesis}
        % \end{array}\\
      &=& \psint{\Gamma, J \seq \Delta} &\\
      &=& \psint{(J \seq) \mix S} &
    \end{array}
    $$
    \item[\rcase] Suppose $\bradepth{\J} > 0$. Then $\J =
    {\piq{\cS}}$, and for all $S_0 = \Gamma_0 \JB \Delta_0 \in
    \cS$ we have that $\bradepth{\JB} < \bradepth{\J}$. Thus we have
    $$
    \begin{array}{rcll}
      \psint{(\seq I) \mix S}
      &=& \psint{\Gamma \piq{\cS} I, \Delta} & \\
      &=& \bigwedge_{S_0 \in \cS}{\psint{(\Gamma \seq I, \Delta) \mix S_0}} & \\
      &=& \bigwedge_{S_0 \in \cS}{\psint{(\seq I) \mix ((\Gamma \seq \Delta) \mix S_0)}} & \\
      &\sementX& \bigwedge_{S_0 \in \cS}{\psint{(\seq J) \mix ((\Gamma \seq \Delta) \mix S_0)}} &\text{(IH)} \\
      &=& \bigwedge_{S_0 \in \cS}{\psint{(\Gamma \seq J, \Delta) \mix S_0}} & \\
      &=& \psint{\Gamma \piq{\cS} J, \Delta} & \\
      &=& \psint{(\seq J) \mix S} &
    \end{array}
    $$
    $$
    \begin{array}{rcll}
      \psint{(I \seq) \mix S}
      &=& \psint{\Gamma, I \piq{\cS} \Delta} & \\
      &=& \bigwedge_{S_0 \in \cS}{\psint{(\Gamma, I \seq \Delta) \mix S_0}} & \\
      &=& \bigwedge_{S_0 \in \cS}{\psint{(I \seq) \mix ((\Gamma \seq \Delta) \mix S_0)}} & \\
      &\sementX& \bigwedge_{S_0 \in \cS}{\psint{(J \seq) \mix ((\Gamma \seq \Delta) \mix S_0)}} &\text{(IH)} \\
      &=& \bigwedge_{S_0 \in \cS}{\psint{(\Gamma, J \seq \Delta) \mix S_0}} & \\
      &=& \psint{\Gamma, J \piq{\cS} \Delta} & \\
      &=& \psint{(J \seq) \mix S} &
    \end{array}
    $$
  \end{itemize}
\end{proof}

In order to ease reasoning by induction on solution contexts, we give a
formulation equivalent to \refdef{solution-context} as a context-free grammar:
\begin{fact}
  Solution contexts $S\hole$ are generated by the following grammar:
  $$
    S\hole \Coloneq \hole \mid \Gamma \J S\hole, \Delta
                          \mid \Gamma, S\hole \J \Delta
                          \mid \Gamma \piq{\cS \sep S\hole} \Delta
  $$
\end{fact}

\begin{definition}\labdef{solctx-depth}
The \emph{depth} $\soldepth{S\hole}$ of a solution context $S\hole$ is defined
recursively as follows:
\begin{align*}
  \soldepth{\hole} &= 0 \\
  \soldepth{\Gamma \J S\hole, \Delta} = \soldepth{\Gamma, S\hole \J \Delta} =
  \soldepth{\Gamma \piq{\cS \sep S\hole} \Delta} &= 1 + \soldepth{S\hole}
\end{align*}
\end{definition}

\begin{lemma}[Contextual soundness]\lablemma{bubbles-ctx-soundness}

  If $S \lstep T$ then $\psint{U\select{T} \mix (\Gamma \seq \Delta)} \sementC
  \psint{U\select{S} \mix (\Gamma \seq \Delta)}$.
  % and $\nsint{S \mix (\Gamma \seq \Delta)} \sement
  % \nsint{T \mix (\Gamma \seq \Delta)}$.
\end{lemma}
\begin{proof}
  By recurrence on $\soldepth{U\hole}$.
  \begin{itemize}
    \item[\bcase] Suppose $\soldepth{U\hole}$ = 0. Then $U\hole =
    \hole$, and we conclude by local soundness
    (\reflemma{bubbles-local-soundness}).
    \item[\textbf{Positive case}] Suppose $\soldepth{U\hole} > 0$ and $U\hole =
    \Gamma' \J U_0\hole, \Delta'$. Then by IH we have $\psint{U_0\select{T}}
    \sementC \psint{U_0\select{S}}$, and thus
    $$
    \begin{array}{rcll}
      \psint{(\Gamma' \J U_0\select{T}, \Delta') \mix (\Gamma \seq \Delta)}
      &=& \psint{(\seq U_0\select{T}) \mix (\Gamma, \Gamma' \J \Delta', \Delta)} &\\
      &\sementC& \psint{(\seq U_0\select{S}) \mix (\Gamma, \Gamma' \J \Delta', \Delta)} &\text{(\reflemma{bubbles-functoriality})}\\
      &=& \psint{(\Gamma' \J U_0\select{S}, \Delta') \mix (\Gamma \seq \Delta)} &
    \end{array}
    $$

    \item[\textbf{Negative case}] Suppose $\soldepth{U\hole} > 0$ and $U\hole =
    \Gamma', U_0\hole \J \Delta'$. Then by \reflemma{local-rule-duality} we have
    $\soldual{S} \lstep \soldual{T}$, and thus by IH
    $\psint{\soldual{U_0}\select{\soldual{T}}} \sementC
    \psint{\soldual{U_0}\select{\soldual{S}}}$, or equivalently
    $\psint{\soldual{U_0\select{T}}} \sementC \psint{\soldual{U_0\select{S}}}$.
    Then by \reflemma{int-invert} we get $\nsint{U_0\select{S}} \sementC
    \nsint{U_0\select{T}}$, and thus
    $$
    \begin{array}{rcll}
      \psint{(\Gamma', U_0\select{T} \J \Delta') \mix (\Gamma \seq \Delta)}
      &=& \psint{(U_0\select{T} \seq) \mix (\Gamma, \Gamma' \J \Delta', \Delta)} &\\
      &\sementC& \psint{(U_0\select{S} \seq) \mix (\Gamma, \Gamma' \J \Delta', \Delta)} &\text{(\reflemma{bubbles-functoriality})}\\
      &=& \psint{(\Gamma', U_0\select{S} \J \Delta') \mix (\Gamma \seq \Delta)} &
    \end{array}
    $$

    \item[\textbf{Neutral case}] Suppose $\soldepth{U\hole} > 0$ and $U\hole =
    \Gamma \piq{\cS \sep U_0\hole} \Delta$. Then by IH we have
    $\psint{U_0\select{T} \mix (\Gamma \seq \Delta)} \sementC
    \psint{U_0\select{S} \mix (\Gamma \seq \Delta)}$, and thus
    $$
    \begin{array}{rcll}
      \psint{\Gamma \piq{\cS \sep U_0\select{T}} \Delta}
      &=& \psint{\Gamma \piq{\cS} \Delta} \land \psint{U_0\select{T} \mix (\Gamma \seq \Delta)} &\\
      &\sementC& \psint{\Gamma \piq{\cS} \Delta} \land \psint{U_0\select{S} \mix (\Gamma \seq \Delta)} &\\
      &=& \psint{\Gamma \piq{\cS \sep U_0\select{S}} \Delta} &
    \end{array}
    $$
  \end{itemize}
\end{proof}

\begin{theorem}[Soundness]\labthm{bubbles-soundness}
  If $S \step T$ then $\psint{T} \sementC \psint{S}$.
\end{theorem}
\begin{proof}
  By definition of $\step$, and then applying \reflemma{bubbles-ctx-soundness}
  with $\Gamma = \Delta = \emptyset$.
\end{proof}

We also get for free soundness with respect to the negative interpretation,
which we call \emph{co-soundness}:

\begin{theorem}[Co-soundness]\labthm{bubbles-cosoundness}
  If $S \step T$ then $\nsint{S} \sementC \nsint{T}$.
\end{theorem}
\begin{proof}
  By \reflemma{rule-duality} we have $\soldual{S} \step \soldual{T}$,
  and thus by soundness $\psint{\soldual{T}} \sementC \psint{\soldual{S}}$. Then
  we can conclude by \reflemma{int-invert}.
\end{proof}

As for local soundness (Corollaries \ref{cor:lsoundness} and
\ref{cor:lcosoundness}), we can easily generalize the proof of
\reflemma{bubbles-ctx-soundness} to Heyting and Heyting-Brouwer algebras, and
thus extend our soundness result to intuitionistic and bi-intuitionistic logic:

\begin{corollary}\label{cor:soundness}
  \sbr
  \begin{itemize}
    \item $S \stepsys{\sysBH} T$ implies $\psint{T} \sement \psint{S}$
    \item $S \stepsys{\sysBHB} T$ implies $\psint{T} \sementHB \psint{S}$
  \end{itemize}
\end{corollary}
\begin{proof}
  \reflemma{bubbles-local-soundness} is the only lemma used in
  \reflemma{bubbles-ctx-soundness} that relies on Boolean algebras. Thus we can
  easily replace it by Corollary \ref{cor:lsoundness} to get soundness in Heyting-Brouwer
  algebras.

  For soundness in Heyting algebras, we know that the negative case will never
  happen because formulas cannot contain exclusions. The other cases only depend
  on \reflemma{bubbles-local-soundness}, thus we can again replace it by
  Corollary \ref{cor:lsoundness}.
\end{proof}

Once again in order to extend contextual soundness to dual-intuitionistic logic,
we need to dualize lemmas to the negative interpretation:

\begin{lemma}[Co-functoriality]\lablemma{bubbles-cofunctoriality}
  Let $\ACVar \in \{\Brouwer, \HeytingBrouwer, \Boolean\}$.
  \sbr
  \begin{itemize}
    \item $\nsint{I} \sementX \nsint{J}$ implies $\nsint{(\seq I) \mix S}
    \sementX \nsint{(\seq J) \mix S}$
    \item $\psint{J} \sementX \psint{I}$ implies $\nsint{(I \seq) \mix S}
    \sementX \nsint{(J \seq) \mix S}$
  \end{itemize}
\end{lemma}

\begin{lemma}[Contextual co-soundness]\lablemma{bubbles-ctx-cosoundness}
  If $S \lstep T$ then $\nsint{U\select{S} \mix (\Gamma \seq \Delta)} \sementC
  \nsint{U\select{T} \mix (\Gamma \seq \Delta)}$.
\end{lemma}

From the assumed proof of \reflemma{bubbles-ctx-cosoundness}, we finally get:

\begin{corollary}\label{cor:cosoundness}
  $S \stepsys{\sysBB} T$ implies $\nsint{S} \sementB \nsint{T}$.
\end{corollary}

Combined with the completeness proof of \refsec{bubbles-completeness}, this will
give us our main result that $\sysBH$, $\sysBB$, $\sysBHB$ and $\sysB$ capture
exactly provability in intuitionistic, dual-intuitionistic, bi-intuitionistic
and classical logic.