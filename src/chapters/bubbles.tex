\setchapterpreamble[u]{\margintoc}
\chapter{Bubble Calculi}
\labch{bubbles}

We introduce a new kind of nested sequent proof systems dubbed \emph{bubble
calculi}. Inspired by the \emph{membrane} mechanism of the chemical abstract
machine ({\cham} hereafter) \sidecite[25em]{berry_chemical_1989}, so-called
\emph{bubbles} internalize the notion of \emph{subgoal} inside sequents, rather
than through the tree structure induced by inference rules. This allows for a
more hierarchical representation of the proof state, where contexts can be
shared between different subgoals. In addition to the usual textual syntax,
bubble calculi can be expressed in a graphical syntax, where logical meaning is
captured by \emph{physical} constraints on diagrammatic manipulations, instead
of \emph{virtual} restrictions on available inference rules. In the chemical
metaphor, \emph{intuitionism} is then characterized as the phenomenon of
\emph{repulsion} between objects that have the same polarity.

The chapter is organized mostly chronologically, following the evolution of our
idea of a bubble calculus through the addition of new features. We start in
\refsec{chemical} with the genesis of the idea, coming from the observation that
our Proof-by-Action paradigm (\refch{pba}) lends itself quite naturally to a
metaphorical interpretation, where actions are seen as \emph{chemical}
reactions. In \refsec{bubbles} we introduce the concept of \emph{bubble} as a
way to control the scope of hypotheses inside nested sequents that we call
\emph{solutions}. In \refsec{asymmetric} we describe a first proof system for
intuitionistic logic dubbed \emph{asymmetric bubble calculus}, based on multiset
rewriting rules on solutions comprising at most one conclusion. Then in
\refsec{non-determinism} we motivate our quest for a system where all
introduction rules for logical connectives are \emph{invertible}, in order to
reduce non-determinism in proof search. To that effect, we extend in
\refsec{colors} the syntax of solutions so that bubbles can themselves be
\emph{polarized}. This gives rise in \refsec{symmetric-calculus} to the full
\emph{symmetric bubble calculus}, where the subgoal tree is encoded by a new
distinction between \emph{branching} and \emph{terminal} solutions. In
\refsec{bubbles-soundness} we show that by adding or removing 4 inference rules
that define the \emph{porosity} of bubbles, one gets 4 subsystems that capture
respectively intuitionistic, dual-intuitionistic, bi-intuitionistic and
classical logic. In \refsec{bubbles-completeness} we support this claim by
showing that our system is not only sound, but also complete with respect to
standard sequent calculi. Finally we present a fully invertible variant of the
symmetric bubble calculus in \refsec{invertible-calculus}, inspired by ideas
that will be developed in subsequent chapters.


\section{The chemical metaphor}\labsec{chemical}

The Proof-by-Action paradigm introduced in \refch{pba} offers multiple ways to
the user to attack the proof of a theorem: DnD actions for subformula linking
and equality rewriting are the main mechanism, but they only work in a goal
comprising multiple items. Since it is customary in proof assistants to specify
the goal to be proved as a single logical formula, one needs a way to decompose
it into many items for further processing through DnD. This is precisely what
the introduction rules for logical connectives in sequent calculus do, and
following the Proof-by-Pointing paradigm \cite{PbP} we map them to click
actions.

So visually, a proof in Actema consists in breaking logical items into subitems
positioned freely in space, and then bringing those subitems together to make
them interact and produce a new item. This is quite evocative of a
\emph{chemical reaction} controlled by the user, where logical formulas are akin
to molecules made of propositional atoms linked together by logical
connectives\sidenote{This precise metaphor about the molecular structure of
propositions can already be found in Russell's introduction to Wittgenstein's
Tractatus Logico-Philosophicus, which was the main inspiration to his philosophy
of \emph{logical atomism} \cite{tractatus-chemical}\cite{klement_russells_2020}.
Even earlier in the history of logic, C. S. Peirce took inspiration from
chemical diagrams to devise his \emph{existential graphs} (that we introduce in
\refch{eg}) \cite{Roberts1973-chemical}.}. Click actions are then a mean to
``heat'' molecules to the point of breaking these chemical bonds. The most
canonical examples are the right-introduction rule for implication $\limp$ and
the left-introduction rule for conjunction $\land$, which break respectively a
conclusion/red item/positive ion into a hypothesis/blue item/negative ion and a
new conclusion, and a hypothesis into two hypotheses. In fact, it is strongly
conjectured that these are the only click actions needed to obtain a complete
deductive system for propositional logic: breaking red implications allows for
backward DnDs, and blue conjunctions for forward DnDs\sidenote{In predicate
logic, one would also need the right (resp. left) introduction rule for
$\forall$ (resp. $\exists$). It might also be the case that backward DnDs alone
are sufficient for completeness, since a linkage of the form $A \back \select{B}
\limp C$ will involve a forward phase. In this case only the right introduction
rules for $\limp$ and $\forall$ would be required.}.
% \sidenote{Interestingly,
% those rules are the basis for the adjunction between $\land$ and $\limp$ in the
% interpretation of IPL into cartesian closed categories.}

Rather than completeness, the issue here is \emph{consistency} of the user
interface: if the user is allowed to decompose red $\limp$ and blue $\land$, she
will assume naturally that she can also decompose blue $\limp$ and red $\land$,
as well as $\lor$ of any color. While red $\lor$ can be handled by pointing
directly at the disjunct to be proved, other configurations correspond to rules
of sequent calculus with multiple premisses. In Actema, this corresponds to
creating a new subgoal for each premise, where subgoals are displayed one at a
time in different \emph{tabs}: this new interface mechanism breaks the chemical
metaphor. The root cause lies in the way sequent calculus implements
\emph{context-scoping}: each subgoal will share the same initial context of
hypotheses, but future hypotheses ``buried'' in the conclusions must be
available only in their respective subgoals. The tabs mechanism implements this
by forcing the user to focus on exactly one tab/subgoal, thus making it
impossible to display items from different subgoals on the same screen, which
renders interaction between them physically impossible.


\section{Bubbles and solutions}\labsec{bubbles}

In order to accomodate context-scoping within the chemical metaphor, we were led
to explore a notion of \emph{bubble} inspired by the \emph{membranes} of the
{\cham} \cite{berry_chemical_1989}. The latter are used to delineate zones of
\emph{local} interaction, which are still porous to external data. This is
precisely what we want to do here: let us consider that the user tries to prove
the sequent $\Gamma \seq A \land B$. By clicking on the red item $A \land B$,
she will break it into two bubbles $\bubbleT{\seq A}$ and $\bubbleT{\seq B}$.
Then she might decompose $A$ and $B$ further into sequents $\sigma_A = \Gamma_A
\seq C_A$ and $\sigma_B = \Gamma_B \seq C_B$, and use hypotheses from $\Gamma$
by dragging them inside either $\bubbleT{\sigma_A}$ or $\bubbleT{\sigma_B}$.
However, hypotheses from $\Gamma_A$ and $\Gamma_B$ cannot be dragged out from
their respective bubble, since then they could be used in the other bubble and
violate context-scoping.

This situation is illustrated in \reffig{bubbles-flow}, where bubbles are
represented by gray circles, and possible drag moves of formulas by arrows. More
specifically, green and orange arrows symbolize respectively valid and invalid
moves. Notice how this graphical depiction of bubbles exhibits their
\emph{topological} behavior: while objects can enter inside bubbles from the
outside, they get blocked by the membrane in the opposite direction. Indeed the
only relevant feature of the circle representation is that it divides the space
into an \emph{interior} and an \emph{exterior}. Then the \emph{nesting} of
circles and the \emph{positions} of formulas relative to them encode
respectively the \emph{tree} structure of the proof, and the scope of hypotheses
in it.

\begin{figure}
  \scalebox{1.5}{\tikzfig{bubbles-flow}}
  \caption{Context-scoping in bubbles as topological constraints}
  \labfig{bubbles-flow}
\end{figure}

Bubbles can also be seen as a way to internalize in the syntax of sequents the
notion of \emph{subgoal}, which requires in turn to allow nesting of sequents
inside each other. The proof state is not a set of subgoals anymore, but a
single nested sequent of this sort, that we call a \emph{solution}\sidenote{The
term ``solution'' refers here to the metaphor of a \emph{chemical solution} made
up of an unordered collection of molecules. Which is quite ironic, since we use
it to denote goals waiting to be proved, that is problems lacking a
solution\dots}. In textual syntax, solutions $S$ are generated by the
following grammar:
\begin{mathpar}
  S, T, U \Coloneq \Gamma \piq{S_1 \sep \ldots \sep S_n} \Delta
  \and
  \Gamma, \Delta \Coloneq A_1, \ldots, A_n
\end{mathpar}
where the $A_i$ are usual formulas of FOL. Thus solutions are just like
sequents, except that we add a collection of nested solutions $S_i$ that will
represent subgoals, or premisses of usual inference rules. To be more precise,
the collections of formulas $A_i$ and solutions $S_i$ are \emph{multisets},
which gives the following mutually recursive definitions:
\begin{definition}[Ion]
  An \emph{ion} is a formula charged either \emph{negatively} (hypothesis) or
  \emph{positively} (conclusion).
\end{definition}
\begin{definition}[Bubble]
  A \emph{bubble} is a solution enclosed in a membrane.
\end{definition}
\begin{definition}[Solution]\labdef{solution}
  A \emph{solution} $S$ is a multiset of ions and bubbles. It is
  \emph{single-conclusion} if it contains at most one positive ion. We will use
  letters $\mathcal{S}, \mathcal{T}, \mathcal{U}$ to denote multisets of
  solutions.
\end{definition}
Note that in the above definitions, bubbles play a purely metaphorical role and
could be dispensed with. But it will be useful later on to distinguish them
conceptually from solutions.

\section{Asymmetric calculus}\labsec{asymmetric}

\subsection{Interpreting solutions}

A natural way to give logical meaning to a solution is to translate it into a
formula. In the following we provide one such translation, which will play a
determining role in the design of inference rules for manipulating solutions. We
qualify it of \emph{asymmetric} because it only works for single-conclusion
solutions, in the same way that \sys{LJ} only works for single-conclusion
sequents.

\begin{remark}
In this section we only deal with single-conclusion solutions, but the more
general case will be studied starting from \refsec{colors}.
\end{remark}

Just like a sequent, a solution is semantically equivalent to an implication,
except that we add the \emph{conjunction} of all subgoals to the consequent:

\begin{definition}[Asymmetric interpretation]
  The \emph{asymmetric interpretation} of a solution is defined recursively by:
  $$\ainterp{\Gamma \piq{S_1 \sep \ldots \sep S_n} \Delta} = \bigwedge \Gamma
    \limp \bigwedge \Delta \land \bigwedge_i{\ainterp{S_i}}$$
\end{definition}

Note that we join formulas in $\Delta$ conjunctively: since we do not consider
solutions with more than one conclusion, this is just to handle the case where
$\Delta = \emptyset$, and thus $\bigwedge \Delta = \top$. This subtle detail is
in fact essential to the way we encode the tree structure of proofs inside
solutions:
\begin{itemize}
  \item a solution with one conclusion corresponds to a \emph{leaf} of the proof
  tree, i.e. a subgoal;
  \item a solution with no conclusion corresponds to a \emph{node} of the proof
  tree, i.e. a branching point where we created multiple subgoals.
\end{itemize}
This will soon become clearer with examples of derivations in our calculus. In
\refsec{symmetric-calculus}, we will consider a different interpretation of
solutions that entails a different encoding of the proof structure in them.

\subsection{Sequent-style rules}

\begin{figure*}
  \begin{framed}
  \renewcommand{\arraystretch}{3}
  \begin{mathpar}
  \begin{array}{r@{\quad}l}
    \multicolumn{2}{c}{\identity} \\[1em]

    \R[\mathsf{i}{\downarrow}]
      {\Gamma \piq{\mathcal{S}} {}}
      {\Gamma, A \piq{\mathcal{S}} A}
    &
    \R[\mathsf{i}{\uparrow}]
      {\Gamma \piq{\mathcal{S} \sep {} \piq{} A \sep A \piq{} \Delta} {}}
      {\Gamma \piq{\mathcal{S}} \Delta} \\
  \end{array}
  \and
  \begin{array}{r@{\quad}l}
    \multicolumn{2}{c}{\resource} \\[1em]

    \R[\mathsf{w}]
      {\Gamma \piq{\mathcal{S}} \Delta}
      {\Gamma, A \piq{\mathcal{S}} \Delta}
    &
    \R[\mathsf{c}]
      {\Gamma, A, A \piq{\mathcal{S}} \Delta}
      {\Gamma, A \piq{\mathcal{S}} \Delta} \\
  \end{array}
  \\
  \begin{array}{r}
    \multicolumn{1}{c}{\flow} \\[1em]

    \R[\mathsf{f{-}}]
      {\Gamma \piq{\mathcal{S} \sep \Gamma', A \piq{\mathcal{S'}} \Delta'} \Delta}
      {\Gamma, A \piq{\mathcal{S} \sep \Gamma' \piq{\mathcal{S'}} \Delta'} \Delta}
  \end{array}
  \and
  \begin{array}{r}
    \multicolumn{1}{c}{\popping} \\[1em]

    \R[\mathsf{p}]
      {\Gamma \piq{\mathcal{S}} \Delta}
      {\Gamma \piq{\mathcal{S} \sep \piq{}} \Delta}
  \end{array}
  \\
  \begin{array}{c@{\quad}c}
    \multicolumn{2}{c}{\heating} \\[1em]

    \R[\top{-}]
      {\Gamma \piq{\mathcal{S}} \Delta}
      {\Gamma, \top \piq{\mathcal{S}} \Delta}
    &
    \R[\top{+}]
      {\Gamma \piq{\mathcal{S}} {}}
      {\Gamma \piq{\mathcal{S}} \top}
    \\
    \R[\bot{-}]
      {\Gamma \piq{\mathcal{S}} {}}
      {\Gamma, \bot \piq{\mathcal{S}} \Delta}
    &\\
    \R[\land{-}]
      {\Gamma, A, B \piq{\mathcal{S}} \Delta}
      {\Gamma, A \land B \piq{\mathcal{S}} \Delta}
    &
    \R[\land{+}]
      {\Gamma \piq{\mathcal{S} \sep {} \piq{} A \sep {} \piq{} B} {}}
      {\Gamma \piq{\mathcal{S}} A \land B}
    \\
    \multirow{2}{*}{
    \R[\lor{-}]
      {\Gamma \piq{\mathcal{S} \sep A \piq{} \Delta \sep B \piq{} \Delta} {}}
      {\Gamma, A \lor B \piq{\mathcal{S}} \Delta}}
    &
    \R[\lor{+}_1]
      {\Gamma \piq{\mathcal{S}} A}
      {\Gamma \piq{\mathcal{S}} A \lor B}
    \\&
    \R[\lor{+}_2]
      {\Gamma \piq{\mathcal{S}} B}
      {\Gamma \piq{\mathcal{S}} A \lor B}
    \\
    \R[{\limp}{-}]
      {\Gamma \piq{\mathcal{S} \sep {} \piq{} A \sep B \piq{} \Delta}}
      {\Gamma, A \limp B \piq{\mathcal{S}} \Delta}
    &
    \R[{\limp}{+}]
      {\Gamma, A \piq{\mathcal{S}} B}
      {\Gamma \piq{\mathcal{S}} A \limp B}
    \\
    \R[\forall{-}]
      {\Gamma, \subst{A}{t}{x} \piq{\mathcal{S}} \Delta}
      {\Gamma, \forall x. A \piq{\mathcal{S}} \Delta}
    &
    \R[\forall{+}]
      {\Gamma \piq{\mathcal{S}} A}
      {\Gamma \piq{\mathcal{S}} \forall x. A}
    \\
    \R[\exists{-}]
      {\Gamma, A \piq{\mathcal{S}} \Delta}
      {\Gamma, \exists x. A \piq{\mathcal{S}} \Delta}
    &
    \R[\exists{+}]
      {\Gamma \piq{\mathcal{S}} \subst{A}{t}{x}}
      {\Gamma \piq{\mathcal{S}} \exists x. A}
  \end{array}
  \end{mathpar}

  In the {\rnm{\forall{+}}} and {\rnm{\exists{-}}} rules, $x$ is not free in
  $\Gamma$, $\Delta$ and $\mathcal{S}$.
  \end{framed}
  \caption{Sequent-style presentation of the asymmetric bubble calculus \sys{BJ}}
  \labfig{sequent-BJ}
\end{figure*}

Our initial idea for a proof system based on solutions was quite simple: we take
the inference rules of \sys{LJ}, and turn them all into unary rules by encoding
premisses as bubbles. This gives the basis for the set of rules presented in
\reffig{sequent-BJ}, that defines our asymmetric bubble
calculus for intuitionistic logic dubbed \sys{BJ}. It is divided in five groups:
\begin{itemize}
  \item The {\identity}, {\resource} and {\heating} groups correspond
  respectively to the identity, structural and logical rules of sequent
  calculus, following the terminology of \sidecite{girard:hal-01322183}; that
  is, the axiom and cut rules, the contraction and weakening rules, and
  introduction rules for logical connectives.
  \item The {\flow} and {\popping} groups are new, and define the behavior of
  bubbles.
  More specifically, $\mathbb{F}$-rules characterize how information flows in
  solutions by specifying what kinds of objects can traverse bubbles, and in
  which direction. They play the same role as \emph{switch} rules in formalisms
  based on the Calculus of Structures \cite{Guglielmi1999ACO}, which includes
  our own subformula linking rules (\reffig{DISL}). In the asymmetric bubble
  calculus there is only one $\mathbb{F}$-rule {\rnmsf{f{-}}} allowing
  hypotheses to flow inside bubbles.
  
  As their name suggests, $\mathbb{P}$-rules allow to \emph{pop} empty bubbles,
  which can be interpreted as the action of dismissing solved subgoals. In the
  Calculus of Structures they would correspond to congruence rules handling the
  truth unit $\top$, and in subformula linking to the unit rules
  (\reffig{DISL-U}). In the asymmetric bubble calculus there is only one
  $\mathbb{P}$-rule {\rnmsf{p}} allowing to pop any empty bubble.
\end{itemize}

Now that we have rules for manipulating solutions, and since solutions can be
nested through bubbles, we need a notion of \emph{context} for applying rules on
subsolutions of arbitrary depth:

\begin{definition}[Solution context]\labdef{solution-context}
  % \emph{Solution contexts} are defined by the following grammar:
  % $$S\hole \Coloneq \hole \mid \Gamma \piq{\mathcal{S} \sep S\hole \sep
  % \mathcal{T}} \Delta$$
  A \emph{solution context} $S\hole$ is a solution which contains exactly one
  occurrence of the special solution $\hole$ called the \emph{hole}. Given
  another solution $T$, we write $S\select{T}$ to denote the solution equal to
  $S\hole$ where $\hole$ has been replaced by $T$.
\end{definition}

Then every rule of \reffig{sequent-BJ} is applicable in any
context $U\hole$. That is:
$$\vcenter{\R{S}{T}} \quad \text{should be read as} \quad
\vcenter{\R{U\select{S}}{U\select{T}}} \quad \text{for all $U\hole$}$$

\begin{definition}[\sys{BJ}-derivation]\labdef{BJ-deriv}
A \emph{derivation} $\deriv{\mathcal{D}}{S}{T}$ in \sys{BJ} is a list
$\mathcal{D}$ of (instances of) inference rules with premiss $T$ and conclusion
$S$\sidenote[][-10cm]{The direction of the arrow is from conclusion to premiss, to stay
consistent with our setting of interactive proof building where inference rules
are seen as goal-modifying actions.}.
\end{definition}

\begin{definition}[\sys{BJ}-proof]\labdef{BJ-proof}
A \emph{proof} of a solution $S$ in \sys{BJ} is a derivation
$\deriv{\mathcal{D}}{S}{\piq{}}$ that reduces $S$ to the empty solution, which
denotes the proof state where there are no subgoals left.
\end{definition}

\begin{marginfigure}
  \begin{mathpar}
    \R[{\limp}{+}]
    {\R[{\land}{+}]
    {\R[{\limp}{+}]
    {\R[{\limp}{+}]
    {\R[\mathsf{c}]
    {\R[\mathsf{f}{-}]
    {\R[\mathsf{f}{-}]
    {\R[{\limp}{-}]
    {\R[\mathsf{i}{\downarrow}]
    {\R[\mathsf{p}]
    {\R[{\lor}{+}_1]
    {\R[\mathsf{f}{-}]
    {\R[\mathsf{i}{\downarrow}]
    {\R[\mathsf{p}]
    {\R[\mathsf{p}]
    {\R[{\limp}{-}]
    {\R[\mathsf{i}{\downarrow}]
    {\R[\mathsf{p}]
    {\R[{\lor}{+}_2]
    {\R[\mathsf{f}{-}]
    {\R[\mathsf{i}{\downarrow}]
    {\R[\mathsf{p}]
    {\R[\mathsf{p}]
    {\piq{}}
    {\piq{\piq{}}}}
    {\piq{\piq{\piq{}}}}}
    {\piq{\piq{B \piq{} B} {}}}}
    {\piq{B \piq{{} \piq{} B} {}}}}
    {\piq{B \piq{{} \piq{} A \lor B} {}}}}
    {\piq{B \piq{{} \piq{} A \lor B \sep \piq{}} {}}}}
    {\piq{B \piq{{} \piq{} A \lor B \sep C \piq{} C} {}}}}
    {\piq{B, A \lor B \limp C \piq{} C} {}}}
    {\piq{\piq{} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{\piq{\piq{}} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{\piq{A \piq{} A} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{A \piq{{} \piq{} A} {} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{A \piq{{} \piq{} A \lor B} {} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{A \piq{{} \piq{} A \lor B \sep \piq{}} {} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{A \piq{{} \piq{} A \lor B \sep C \piq{} C} {} \sep B, A \lor B \limp C \piq{} C} {}}}
    {\piq{A, A \lor B \limp C \piq{} C \sep B, A \lor B \limp C \piq{} C} {}}}
    {A \lor B \limp C \piq{A, A \lor B \limp C \piq{} C \sep B \piq{} C} {}}}
    {A \lor B \limp C, A \lor B \limp C \piq{A \piq{} C \sep B \piq{} C} {}}}
    {A \lor B \limp C \piq{A \piq{} C \sep B \piq{} C} {}}}
    {A \lor B \limp C \piq{A \piq{} C \sep {} \piq{} B \limp C} {}}}
    {A \lor B \limp C \piq{{} \piq{} A \limp C \sep {} \piq{} B \limp C} {}}}
    {A \lor B \limp C \piq{} (A \limp C) \land (B \limp C)}}
    {{} \piq{} (A \lor B \limp C) \limp (A \limp C) \land (B \limp C)}
  \end{mathpar}
  \caption{Example of sequent-style proof in \sys{BJ}}
  \labfig{ex-seq-BJ}
\end{marginfigure}

\subsection{Graphical rules}

\begin{figure*}
  \begin{framed}
  \renewcommand{\arraystretch}{1.25}
  \begin{mathpar}
  \begin{array}{r@{\quad}c@{\quad}lr}
    \multicolumn{4}{c}{\identity} \\[2em]

     \hypo{A}~~\conc{A}
    &\step
    &
    &\mathsf{i}{\downarrow} \\

    &\step
    &\bubble{\conc{A}}~~\bubble{\hypo{A}}
    &\mathsf{i}{\uparrow} \\
  \end{array}
  \and
  \begin{array}{r@{\quad}c@{\quad}lr}
    \multicolumn{4}{c}{\resource} \\[2em]

     \hypo{A}
    &\step
    &
    &\mathsf{w} \\

     \hypo{A}
    &\step
    &\hypo{A~~A}
    &\mathsf{c} \\
  \end{array}
  \vspace{2em}\\
  \begin{array}{r@{\quad}c@{\quad}lr}
    \multicolumn{4}{c}{\flow} \\[2em]

     \hypo{A}~~\bubble{\color{black}S}
    &\step
    &\bubble{\hypo{A}~~S}
    &\mathsf{f{-}} \\
  \end{array}
  \and
  \begin{array}{r@{\quad}c@{\quad}lr}
    \multicolumn{4}{c}{\popping} \\[2em]

     \bubble{\phantom{S}}
    &\step
    &
    &\mathsf{p} \\
  \end{array}
  \vspace{2em}
  \\
  \begin{array}{r@{\quad}c@{\quad}lr@{\qquad\qquad}r@{\quad}c@{\quad}lr}
    \multicolumn{8}{c}{\heating} \\[2em]

     \hypo{\top}
    &\step
    &
    &\mathsf{\top{-}}

    &\conc{\top}
    &\step
    &
    &\mathsf{\top{+}} \\

     \hypo{\bot}~~\conc{\Delta}
    &\step
    &
    &\mathsf{\bot{-}}

    &&&&\\

     \hypo{A \land B}
    &\step
    &\hypo{A}~~\hypo{B}
    &\mathsf{\land{-}}

    &\conc{A \land B}
    &\step
    &\bubble{\conc{A}}~~\bubble{\conc{B}}
    &\mathsf{\land{+}} \\

     \multirow{2}{*}{$\hypo{A \lor B}~~\conc{\Delta}$}
    &\multirow{2}{*}{$\step$}
    &\multirow{2}{*}{$\bubble{\hypo{A}~~\conc{\Delta}}~~\bubble{\hypo{B}~~\conc{\Delta}}$}
    &\multirow{2}{*}{$\mathsf{\lor{-}}$}

    &\conc{A \lor B}
    &\step
    &\conc{A}
    &\mathsf{\lor{+}_2} \\

    &&&

    &\conc{A \lor B}
    &\step
    &\conc{B}
    &\mathsf{\lor{+}_2} \\

     \hypo{A \limp B}~~\conc{\Delta}
    &\step
    &\bubble{\conc{A}}~~\bubble{\hypo{B}~~\conc{\Delta}}
    &\mathsf{{\limp}{-}}

    &\conc{A \limp B}
    &\step
    &\hypo{A}~~\conc{B}
    &\mathsf{{\limp}{+}} \\

     \hypo{\forall x. A}
    &\step
    &\hypo{\subst{A}{t}{x}}
    &\mathsf{\forall{-}}

    &\conc{\forall x. A}
    &\step
    &\conc{\subst{A}{y}{x}}
    &\mathsf{\forall{+}} \\

     \hypo{\exists x. A}
    &\step
    &\hypo{\subst{A}{y}{x}}
    &\mathsf{\exists{-}}

    &\conc{\exists x. A}
    &\step
    &\conc{\subst{A}{t}{x}}
    &\mathsf{\exists{+}} \\
  \end{array}
  \vspace{2em}
  \end{mathpar}
  In the {\rnm{\forall{+}}} and {\rnm{\exists{-}}} rules, $y$ is fresh.
  \end{framed}
  \caption{Graphical presentation of the asymmetric bubble calculus \sys{BJ}}
  \labfig{graphical-BJ}
\end{figure*}

While the sequent-style presentation of \sys{BJ} clearly shows its filiation
with sequent calculus, its syntax is quite heavy, and obscures an important
property of the rules: they almost always preserve the contexts $\Gamma, \Delta$
of formulas and $\mathcal{S}$ of bubbles. That is, the rules of \sys{BJ} are
\emph{local}. This enables a more concise and graphical presentation of the
rules in \reffig{graphical-BJ}, where \sys{BJ} is seen as a multiset rewriting
system just like the {\cham} thanks to \refdef{solution}. Instead of relying on
a notion of solution context, we define formally what it means to be a
subsolution:

\begin{definition}[Subsolution]
  $S$ is a \emph{subsolution} of $T$, written $S \subsol T$, if either $S
  \subseteq T$ or $S \subsol T_0$ for some $T_0 \in T$, where $\subseteq$
  denotes multiset inclusion. 
\end{definition}

Then a multiset rewriting rule $\rrule{\mathsf{r}}{S}{T}$ can be applied in a
solution $U$ whenever $S \subsol U$, by replacing one occurrence of $S$ by $T$
inside $U$. The notions of derivation (\refdef{BJ-deriv}) and proof
(\refdef{BJ-proof}) stay unchanged, by observing that the rewriting rule
$\rrule{\mathsf{r}}{S}{T}$ from $S$ to $T$ and the inference rule
$\irule{\mathsf{r}}{S}{T}$ with premiss $T$ and conclusion $S$ denote the same
rule $\mathsf{r}$.

\todo{add definition of multiset inclusion somewhere?}

Beyond the recovered uniformity of the user interface in terms of the chemical
metaphor, \sys{BJ} exhibits some features that are interesting both at the
proof-theoretical and user-experience levels:
\begin{itemize}
  \item It implements a form of \emph{context-sharing} between subgoals: that
    is, one can perform transformations on shared hypotheses (forward reasoning)
    without going back to a proof state anterior to the splitting of said
    subgoals.
  \item The tree structure of subgoals is immediately apparent in the proof
    state through the nesting of solutions in bubbles. Thus part of the
    information on the proof construction process, which was made implicit and
    temporal in the proof state history, is now made explicit and spatial in the
    proof state itself\sidenote{This concern of finding an explicit graphical
    representation of the ``motions of reasoning \emph{in actu}'', and not only
    the states of mind, can be found already in the works of Peirce on his
    existential graphs \cite{Roberts1973-inactu}. We will come back to this in
    \refch{eg}.}. There are multiple ways to visualize trees on a planar
    surface, but if we are to maintain the bubble metaphor, \emph{zoomable user
    interfaces} seem to be a right fit: they allow for efficient space
    management and navigation, and zooming in intuitively conveys the idea of
    focusing on a specific subgoal. One could also zoom out to have an overview
    of the different subgoals and their shared context, something which is hard
    to do in current proof assistants.
  \item From a user perspective, the locality of rules means that applying some
    action to one or two items will not involve other items (the only exceptions
    are clicks on blue $\bot$ and $\lor$, but the only extra item they involve
    is the conclusion). Non-local rules are less natural for a beginner, because
    they modify a global state (here other items) which is not clearly
    correlated to the transformed data.
    % This is of limited importance however in our case, because sequent calculus
    % rules always perform the same trivial operation on the global state:
    % duplicating the whole context of hypotheses.
\end{itemize}

\section{Reducing non-determinism}\labsec{non-determinism}

\section{Coloring bubbles}\labsec{colors}

\section{Symmetric calculus}\labsec{symmetric-calculus}

\section{Soundness}\labsec{bubbles-soundness}

\section{Completeness}\labsec{bubbles-completeness}

\section{Invertible calculus}\labsec{invertible-calculus}

\section{Integrating subformula linking}\labsec{bubbles-sfl}

\todo{ Present interaction rules from the Intuitionistic Chemical Proof Machine.
They account both for SFL DnD, and other kinds of DnD actions like quantifier
instantiations if we extend the notion of solutions to include local
definitions. Note that this could also work with a sequent-style presentation,
but the local character of the graphical presentation is closer to the intuition
of the objects actually involved in the action. }